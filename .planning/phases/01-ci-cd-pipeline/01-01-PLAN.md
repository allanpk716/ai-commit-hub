---
phase: 01-ci-cd-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/build.yml
  - pkg/version/version.go
autonomous: true

must_haves:
  truths:
    - Push tag to GitHub triggers automated build workflow
    - Build process injects version, commit SHA, and build time into binary
    - Build completes successfully and produces Windows amd64 executable (per CONTEXT.md locked decision: amd64 only)
    - Version information can be retrieved from compiled binary
  artifacts:
    - path: .github/workflows/build.yml
      provides: Main CI/CD workflow configuration
      contains: name, on, jobs, build steps
    - path: pkg/version/version.go
      provides: Version variable injection points
      contains: Version, CommitSHA, BuildTime variables
    - path: build/bin/ai-commit-hub.exe
      provides: Compiled Windows executable
      min_lines: 1
  key_links:
    - from: .github/workflows/build.yml
      to: pkg/version
      via: ldflags injection
      pattern: -X 'github.com/allanpk716/ai-commit-hub/pkg/version\.
    - from: .github/workflows/build.yml
      to: build/bin/ai-commit-hub.exe
      via: wails build command
      pattern: wails build
---

<objective>
Create GitHub Actions workflow for automated Wails application builds triggered by version tags.

Purpose: Establish the foundational CI/CD infrastructure that enables automated builds on version tag pushes, ensuring consistent release artifacts without manual intervention.

Output: Working GitHub Actions workflow that builds Windows amd64 executable with embedded version information.
</objective>

<execution_context>
@C:\Users\allan716\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\allan716\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-ci-cd-pipeline/01-CONTEXT.md
@.planning/phases/01-ci-cd-pipeline/01-RESEARCH.md

@.github/workflows/release.yml
@wails.json
@pkg/version/version.go
</context>

<tasks>

<task type="auto">
  <name>Create new build.yml workflow with proper structure</name>
  <files>.github/workflows/build.yml</files>
  <action>
Create .github/workflows/build.yml with the following structure:

1. Trigger conditions:
   - push.tags: 'v*' (version tags)
   - workflow_dispatch (manual trigger)

2. Single job "build" with:
   - runs-on: windows-latest
   - timeout-minutes: 30
   - env: NODE_OPTIONS: "--max-old-space-size=4096" (prevents OOM)

3. Use dAppServer/wails-build-action@v3 with:
   - build-name: ai-commit-hub
   - build-platform: windows/amd64
   - package: false (we package manually)
   - go-version: '1.21' (matching go.mod)

4. Build ONLY for windows/amd64 platform - per CONTEXT.md locked decision, 386 (32-bit) is explicitly excluded due to Wails limitations (known WebView2 crashes)

5. Extract version metadata:
   - VERSION from GITHUB_REF#refs/tags/v
   - SHA from git rev-parse --short HEAD
   - DATE from date command (ISO 8601 format)
   - PRERELEASE detection: regex match for -(alpha|beta|rc|pre)

Note: The existing release.yml has incorrect ldflags path (-X main.version). We use pkg/version package instead.
  </action>
  <verify>
File .github/workflows/build.yml exists and contains:
- name: Build
- on: push.tags.v*
- dAppServer/wails-build-action@v3
- NODE_OPTIONS environment variable
  </verify>
  <done>
Workflow file is syntactically valid YAML with all required sections defined
  </done>
</task>

<task type="auto">
  <name>Configure version injection via ldflags</name>
  <files>.github/workflows/build.yml</files>
  <action>
Add build step that injects version information using ldflags.

The step should:
1. Run AFTER wails-build-action (since action doesn't support custom ldflags)
2. Use wails build -clean command with proper ldflags
3. Inject THREE variables into pkg/version package:
   - Version (from tag, e.g., "1.0.0")
   - CommitSHA (short git hash)
   - BuildTime (ISO 8601 timestamp)
4. Include -s -w flags to strip debug info (reduces binary size by ~30%)

Command structure:
```bash
wails build -clean -ldflags "
  -X 'github.com/allanpk716/ai-commit-hub/pkg/version.Version=${{ steps.meta.outputs.VERSION }}'
  -X 'github.com/allanpk716/ai-commit-hub/pkg/version.CommitSHA=${{ steps.meta.outputs.SHA }}'
  -X 'github.com/allanpk716/ai-commit-hub/pkg/version.BuildTime=${{ steps.meta.outputs.DATE }}'
  -s -w"
```

Set CGO_ENABLED: '1' environment variable (required for Windows SQLite driver).
  </action>
  <verify>
Workflow contains:
- "Inject version info" or similar step name
- All three ldflags -X flags pointing to pkg/version package
- -s -w flags in ldflags
- CGO_ENABLED: '1' env var
  </verify>
  <done>
Version injection step correctly references pkg/version package paths
  </done>
</task>

<task type="auto">
  <name>Add version verification step</name>
  <files>.github/workflows/build.yml</files>
  <action>
Add a verification step after version injection that confirms the version info was embedded correctly.

Step should:
1. Run ./build/bin/ai-commit-hub.exe --version
2. Check exit code is 0
3. Output version info for workflow logs

This ensures the ldflags injection worked before proceeding to packaging.
  </action>
  <verify>
Workflow contains step that runs ai-commit-hub.exe --version or similar version check
  </verify>
  <done>
Verification step will catch ldflags errors before packaging
  </done>
</task>

</tasks>

<verification>
After creating the workflow, verify:

1. YAML syntax is valid (no indentation errors)
2. All required actions are referenced correctly (@v3, @v4 versions)
3. Version extraction uses correct GITHUB_REF syntax
4. ldflags paths match actual pkg/version package structure
5. Workflow would trigger on v* tag push
</verification>

<success_criteria>
1. .github/workflows/build.yml file exists with valid YAML syntax
2. Workflow triggers on version tag pushes (v*)
3. Workflow uses dAppServer/wails-build-action@v3
4. Version injection uses correct pkg/version package paths
5. NODE_OPTIONS is set to prevent OOM
6. Verification step confirms version embedding
7. Workflow aligns with CONTEXT.md locked decision: amd64 only (no 386 builds per Wails limitations)
</success_criteria>

<output>
After completion, create `.planning/phases/01-ci-cd-pipeline/01-01-SUMMARY.md` with:
- Workflow structure overview
- Key decisions (why amd64 only, NODE_OPTIONS value)
- Version injection approach
</output>
