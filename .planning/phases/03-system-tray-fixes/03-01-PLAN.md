---
phase: 03-system-tray-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [go.mod, app.go]
autonomous: false

must_haves:
  truths:
    - "双击托盘图标能够恢复并激活主界面到前台"
    - "双击事件日志记录在应用日志中可见"
    - "构建成功,无编译错误"
  artifacts:
    - path: "go.mod"
      provides: "依赖声明,使用 energye/systray v1.0.3+"
      contains: "github.com/energye/systray"
    - path: "app.go"
      provides: "双击托盘图标显示窗口功能"
      exports: ["onSystrayReady", "SetOnDClick"]
      min_lines: 420
  key_links:
    - from: "app.go:onSystrayReady"
      to: "github.com/energye/systray"
      via: "systray.SetOnDClick() callback"
      pattern: "SetOnDClick\\(func\\(\\)"
    - from: "app.go:onSystrayReady"
      to: "app.showWindow"
      via: "双击回调调用 a.showWindow()"
      pattern: "a\\.showWindow\\(\\)"
---

<objective>
升级 systray 库并实现托盘图标双击功能

Purpose: 现有 getlantern/systray v1.2.2 不支持双击事件,需要升级到支持双击的 energye/systray fork,并实现双击托盘图标显示窗口的功能。

Output: 升级后的依赖配置,迁移到 callback API 的新代码,双击托盘图标能够激活主窗口。
</objective>

<execution_context>
@C:\Users\allan716\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\allan716\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-system-tray-fixes/03-RESEARCH.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Current systray implementation
@app.go (lines 21, 323-412)
</context>

<tasks>

<task type="auto">
  <name>Task 1: 升级 systray 库到 energye/systray</name>
  <files>go.mod</files>
  <action>
    1. 在 go.mod 中将依赖从 getlantern/systray v1.2.2 更换为 energye/systray:
       - 移除: github.com/getlantern/systray v1.2.2
       - 添加: github.com/energye/systray v1.0.3 (或最新版本)

    2. 运行 go mod tidy 清理依赖:
       ```bash
       cd C:/WorkSpace/Go2Hell/src/github.com/allanpk716/ai-commit-hub
       go mod tidy
       ```

    3. 验证依赖更新成功:
       ```bash
       go mod verify
       go list -m github.com/energye/systray
       ```

    注意事项:
    - 如果 energye/systray 有问题,备选方案是 lutischan-ferenc/systray v1.3.0
    - 两个库的 API 几乎相同,可以直接切换
  </action>
  <verify>go list -m github.com/energye/systray 输出版本号</verify>
  <done>go.mod 显示 energye/systray v1.0.3+, go mod tidy 无错误</done>
</task>

<task type="auto">
  <name>Task 2: 迁移到 callback API 并实现双击支持</name>
  <files>app.go</files>
  <action>
    1. 更新 import 语句 (line 21):
       将: github.com/getlantern/systray
       改为: github.com/energye/systray

    2. 在 onSystrayReady() 方法中添加双击处理 (在设置图标之后,添加菜单之前):
       ```go
       func (a *App) onSystrayReady() {
           // ... 现有的图标设置代码 ...

           // NEW: 双击托盘图标显示窗口
           systray.SetOnDClick(func() {
               logger.Info("托盘图标双击,显示窗口")
               a.showWindow()
           })

           // ... 现有的菜单代码 ...
       }
       ```

    3. 迁移菜单项从 Channel API 到 Callback API (lines 378-394):
       将现有的 ClickedCh 模式:
       ```go
       menu := systray.AddMenuItem("显示窗口", "显示主窗口")
       go func() {
           for range menu.ClickedCh {
               a.showWindow()
           }
       }()
       ```

       改为 Callback 模式:
       ```go
       menu := systray.AddMenuItem("显示窗口", "显示主窗口")
       menu.Click(func() {
           a.showWindow()
       })
       ```

       同样更新 quitMenu 的处理。

    4. 添加右键菜单支持 (可选但推荐):
       ```go
       systray.SetOnRClick(func(menu systray.IMenu) {
           menu.ShowMenu()
       })
       ```

    重要注意事项:
    - 必须使用 a.showWindow() 而非直接调用 runtime.WindowShow()
    - 保持现有的退出逻辑 (sync.Once + atomic.Bool) 不变
    - SetOnDClick 必须在 AddMenuItem 之前调用
  </action>
  <verify>go build -o build/bin/ai-commit-hub.exe . 编译成功无错误</verify>
  <done>编译成功,代码使用 callback API,包含 SetOnDClick 双击处理</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>systray 库升级和双击功能实现</what-built>
  <how-to-verify>
    1. 构建应用:
       ```bash
       wails build
       ```
       或
       ```bash
       go build -o build/bin/ai-commit-hub.exe .
       ```

    2. 启动应用,观察系统托盘图标出现

    3. 测试双击功能:
       - 将主窗口隐藏 (点击关闭按钮 X)
       - 双击托盘图标
       - **验证**: 主窗口应该恢复并激活到前台

    4. 测试右键菜单:
       - 右键点击托盘图标
       - **验证**: 应该显示菜单 (显示窗口、退出应用)

    5. 测试菜单项:
       - 左键点击"显示窗口"菜单项
       - **验证**: 主窗口应该显示

    6. 测试退出功能:
       - 点击"退出应用"菜单项
       - **验证**: 应用应该完全退出

    7. 检查日志 (可选):
       - 查看日志文件,搜索 "托盘图标双击"
       - **验证**: 双击时应该有日志记录
  </how-to-verify>
  <resume-signal>输入 "approved" 表示测试通过,或描述遇到的问题</resume-signal>
</task>

</tasks>

<verification>
- [ ] go.mod 使用 energye/systray v1.0.3+
- [ ] app.go import 更新为 github.com/energye/systray
- [ ] onSystrayReady 包含 SetOnDClick 双击处理
- [ ] 菜单项使用 Click(callback) 而非 ClickedCh
- [ ] 构建成功无错误
- [ ] 双击托盘图标能够显示窗口
- [ ] 右键菜单正常工作
</verification>

<success_criteria>
双击托盘图标能够恢复并激活主界面到前台,所有菜单项正常工作。
</success_criteria>

<output>
After completion, create `.planning/phases/03-system-tray-fixes/03-01-SUMMARY.md`
</output>
