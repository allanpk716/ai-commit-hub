---
phase: 07-auto-update-detection-fix
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - frontend/src/stores/updateStore.ts
  - frontend/src/components/AboutDialog.vue
  - frontend/src/components/UpdateDialog.vue
autonomous: false

must_haves:
  truths:
    - "ç”¨æˆ·ç‚¹å‡»æ£€æŸ¥æ›´æ–°æŒ‰é’®æ—¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€"
    - "æ£€æŸ¥æ›´æ–°æ—¶æ˜¾ç¤º toast æç¤ºï¼ˆæ­£åœ¨æ£€æŸ¥/æ£€æŸ¥å®Œæˆ/æ£€æŸ¥å¤±è´¥ï¼‰"
    - "ç½‘ç»œé”™è¯¯æ—¶æ˜¾ç¤ºæ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯å’Œé‡è¯•å»ºè®®"
    - "API é€Ÿç‡é™åˆ¶æ—¶æä¾›ç”¨æˆ·å‹å¥½çš„æç¤º"
    - "å…³äºç•Œé¢æ˜¾ç¤ºå®Œæ•´çš„ç‰ˆæœ¬ä¿¡æ¯å¡ç‰‡"
  artifacts:
    - path: "frontend/src/stores/updateStore.ts"
      exports: ["checkForUpdates", "formatUpdateError"]
    - path: "frontend/src/components/AboutDialog.vue"
      contains: "version-info-card|updateInfo"
    - path: "frontend/src/components/UpdateDialog.vue"
      contains: "formatUpdateError"
  key_links:
    - from: "frontend/src/stores/updateStore.ts"
      to: "frontend/src/stores/errorStore.ts"
      via: "import and useErrorStore"
      pattern: "useErrorStore|addError"
    - from: "frontend/src/components/AboutDialog.vue"
      to: "wailsjs/go/main/App"
      via: "CheckForUpdates"
      pattern: "await CheckForUpdates"
---

<objective>
å¢å¼ºæ›´æ–°æ£€æµ‹çš„ç”¨æˆ·åé¦ˆæœºåˆ¶ï¼Œåœ¨å…³äºç•Œé¢æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯å¡ç‰‡ï¼Œæä¾›æ£€æŸ¥æ›´æ–°æ—¶çš„å³æ—¶åŠ è½½çŠ¶æ€å’Œ toast æç¤ºï¼Œä»¥åŠæ¸…æ™°å‹å¥½çš„é”™è¯¯æ¶ˆæ¯ã€‚

Purpose: ç”¨æˆ·åé¦ˆç‚¹å‡»"æ£€æŸ¥æ›´æ–°"æŒ‰é’®æ²¡æœ‰åé¦ˆï¼Œæ— æ³•åˆ¤æ–­æ£€æµ‹æ˜¯å¦æˆåŠŸã€‚å…³äºç•Œé¢çœ‹ä¸åˆ°ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå½“å‰ç‰ˆæœ¬ã€æœ€æ–°ç‰ˆæœ¬ã€æ›´æ–°çŠ¶æ€ï¼‰ã€‚é€šè¿‡å¢å¼º UI åé¦ˆå’Œé”™è¯¯æç¤ºï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

Output: å¢å¼ºçš„ç‰ˆæœ¬ä¿¡æ¯å±•ç¤ºå’Œç”¨æˆ·åé¦ˆæœºåˆ¶ã€‚
</objective>

<execution_context>
@C:\Users\allan716\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\allan716\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-auto-update-detection-fix/07-CONTEXT.md
@.planning/phases/07-auto-update-detection-fix/07-RESEARCH.md
@.planning/phases/07-auto-update-detection-fix/07-01-SUMMARY.md
@frontend/src/stores/updateStore.ts
@frontend/src/stores/errorStore.ts
@frontend/src/components/AboutDialog.vue
@frontend/src/components/UpdateDialog.vue
@frontend/src/components/ErrorToast.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: å¢å¼º updateStore çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ</name>
  <files>frontend/src/stores/updateStore.ts</files>
  <action>
    ä¿®æ”¹ frontend/src/stores/updateStore.tsï¼Œå¢å¼º checkForUpdates æ–¹æ³•çš„ç”¨æˆ·åé¦ˆï¼š

    1. å¯¼å…¥ useErrorStore
    2. æ·»åŠ  formatUpdateError å·¥å…·å‡½æ•°
    3. ä¿®æ”¹ checkForUpdates æ–¹æ³•æ·»åŠ  toast æç¤º

    åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ  errorStore å¯¼å…¥ï¼š

    ```typescript
    import { useErrorStore } from './errorStore'
    ```

    åœ¨ checkForActions å‡½æ•°ä¸­ä¿®æ”¹ï¼ˆçº¦ç¬¬ 43-58 è¡Œï¼‰ï¼š

    ```typescript
  // Actions
  async function checkForUpdates() {
    const errorStore = useErrorStore()

    isChecking.value = true

    // æ˜¾ç¤ºå³æ—¶åé¦ˆ
    await errorStore.addError(
      'æ­£åœ¨æ£€æŸ¥æ›´æ–°...',
      undefined,
      'warning',
      'UpdateService'
    )

    try {
      // è¿™é‡Œè°ƒç”¨åç«¯ API
      const { CheckForUpdates } = await import('../../wailsjs/go/main/App')
      const info = await CheckForUpdates()
      updateInfo.value = info
      hasUpdate.value = info.hasUpdate

      // æˆåŠŸæç¤ºï¼ˆ2ç§’åè‡ªåŠ¨æ¶ˆå¤±ï¼‰
      if (info.hasUpdate) {
        await errorStore.addError(
          `å‘ç°æ–°ç‰ˆæœ¬ ${info.latestVersion}`,
          `å½“å‰ç‰ˆæœ¬: ${info.currentVersion}`,
          'warning',
          'UpdateService'
        )
      } else {
        await errorStore.addError(
          'å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬',
          `æœ€æ–°ç‰ˆæœ¬: ${info.latestVersion}`,
          'warning',
          'UpdateService'
        )
      }

      return info
    } catch (error) {
      console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', error)

      // è¯¦ç»†é”™è¯¯æç¤ºï¼ˆæ˜¾ç¤º 5 ç§’ï¼‰
      const errorMessage = formatUpdateError(error)
      await errorStore.addError(
        `æ£€æŸ¥æ›´æ–°å¤±è´¥: ${errorMessage}`,
        error instanceof Error ? error.message : String(error),
        'error',
        'UpdateService'
      )

      throw error
    } finally {
      isChecking.value = false
    }
  }

  // æ ¼å¼åŒ–é”™è¯¯æ¶ˆæ¯ï¼ˆç”¨æˆ·å‹å¥½ï¼‰
  function formatUpdateError(error: unknown): string {
    const err = error as { code?: string; message?: string }

    if (err.message?.includes('403')) {
      return 'GitHub API é€Ÿç‡é™åˆ¶ï¼Œè¯·ç¨åå†è¯•æˆ–ç¨åæ‰‹åŠ¨æ£€æŸ¥'
    }

    if (err.message?.includes('timeout') || err.message?.includes('deadline exceeded')) {
      return 'ç½‘ç»œè¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®'
    }

    if (err.message?.includes('failed to fetch') || err.message?.includes('connection refused')) {
      return 'æ— æ³•è¿æ¥åˆ° GitHubï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
    }

    if (err.message?.includes('Atom feed')) {
      return 'GitHub ç‰ˆæœ¬ä¿¡æ¯è·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
    }

    return err.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•'
  }
    ```

    4. åœ¨ return è¯­å¥ä¸­æ·»åŠ  formatUpdateError å¯¼å‡ºï¼š

    ```typescript
  return {
    // ... ç°æœ‰å¯¼å‡º
    formatUpdateError,
    formatBytes,
    formatSpeed,
    calculateETA
  }
    ```
  </action>
  <verify>cd frontend && npm run type-check 2>&1 | head -20</verify>
  <done>checkForUpdates æ–¹æ³•æ·»åŠ å³æ—¶åé¦ˆå’Œé”™è¯¯å¤„ç†ï¼ŒformatUpdateError å‡½æ•°å¯¼å‡º</done>
</task>

<task type="auto">
  <name>Task 2: åœ¨ AboutDialog æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯å¡ç‰‡</name>
  <files>frontend/src/components/AboutDialog.vue</files>
  <action>
    ä¿®æ”¹ frontend/src/components/AboutDialog.vueï¼Œåœ¨ç‰ˆæœ¬ä¿¡æ¯åŒºåŸŸæ·»åŠ å®Œæ•´çš„ç‰ˆæœ¬ä¿¡æ¯å¡ç‰‡ï¼š

    1. åœ¨ script setup éƒ¨åˆ†æ·»åŠ  updateInfo ç›¸å…³çŠ¶æ€
    2. åœ¨ç»„ä»¶æŒ‚è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æ›´æ–°
    3. åœ¨æ¨¡æ¿ä¸­æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯å¡ç‰‡

    ä¿®æ”¹ script setup éƒ¨åˆ†ï¼ˆçº¦ç¬¬ 66-112 è¡Œï¼‰ï¼š

    ```typescript
    <script setup lang="ts">
    import { ref, onMounted, watch } from 'vue'
    import { GetVersion, GetFullVersion, CheckForUpdates } from '../../wailsjs/go/main/App'
    import { useUpdateStore } from '../stores/updateStore'
    import { useErrorStore } from '../stores/errorStore'

    const props = defineProps<{
      visible: boolean
    }>()

    const emit = defineEmits(['close'])

    const updateStore = useUpdateStore()
    const errorStore = useErrorStore()
    const version = ref('åŠ è½½ä¸­...')
    const fullVersion = ref('')
    const isCheckingUpdate = ref(false)
    const updateInfo = ref<{
      latestVersion: string
      currentVersion: string
      hasUpdate: boolean
      publishedAt: string
      releaseNotes: string
      isPrerelease: boolean
    } | null>(null)

    // åŠ è½½ç‰ˆæœ¬ä¿¡æ¯
    async function loadVersion() {
      try {
        version.value = await GetVersion()
        fullVersion.value = await GetFullVersion()
      } catch (error) {
        console.error('è·å–ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥:', error)
        version.value = 'æœªçŸ¥ç‰ˆæœ¬'
        fullVersion.value = ''
      }
    }

    // æ£€æŸ¥æ›´æ–°
    async function checkForUpdates() {
      if (isCheckingUpdate.value) {
        return // é˜²æ­¢é‡å¤ç‚¹å‡»
      }

      isCheckingUpdate.value = true

      try {
        await errorStore.addError(
          'æ­£åœ¨æ£€æŸ¥æ›´æ–°...',
          undefined,
          'warning',
          'AboutDialog'
        )

        const info = await CheckForUpdates()
        updateInfo.value = {
          latestVersion: info.latestVersion,
          currentVersion: info.currentVersion,
          hasUpdate: info.hasUpdate,
          publishedAt: info.publishedAt ? new Date(info.publishedAt).toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          }) : '',
          releaseNotes: info.releaseNotes || '',
          isPrerelease: info.isPrerelease
        }

        if (info.hasUpdate) {
          await errorStore.addError(
            `å‘ç°æ–°ç‰ˆæœ¬ ${info.latestVersion}`,
            `å½“å‰ç‰ˆæœ¬: ${info.currentVersion}`,
            'warning',
            'AboutDialog'
          )
        } else {
          await errorStore.addError(
            'å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬',
            `æœ€æ–°ç‰ˆæœ¬: ${info.latestVersion}`,
            'warning',
            'AboutDialog'
          )
        }
      } catch (error) {
        console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', error)
        await errorStore.addError(
          'æ£€æŸ¥æ›´æ–°å¤±è´¥',
          error instanceof Error ? error.message : String(error),
          'error',
          'AboutDialog'
        )
      } finally {
        isCheckingUpdate.value = false
      }
    }

    // å…³é—­å¯¹è¯æ¡†
    function close() {
      emit('close')
    }

    // æ ¼å¼åŒ–é¢„å‘å¸ƒç‰ˆæœ¬æ˜¾ç¤º
    function formatPrereleaseBadge(isPrerelease: boolean, version: string) {
      if (!isPrerelease) return ''
      if (version.includes('alpha')) return ' (Alpha)'
      if (version.includes('beta')) return ' (Beta)'
      if (version.includes('rc')) return ' (RC)'
      return ' (é¢„å‘å¸ƒ)'
    }

    // ç›‘å¬å¯¹è¯æ¡†æ‰“å¼€ï¼Œè‡ªåŠ¨æ£€æŸ¥æ›´æ–°
    watch(() => props.visible, async (isVisible) => {
      if (isVisible) {
        await loadVersion()
        await checkForUpdates()
      }
    })

    // ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½ç‰ˆæœ¬
    onMounted(async () => {
      if (props.visible) {
        await loadVersion()
        await checkForUpdates()
      }
    })
    </script>
    ```

    ä¿®æ”¹ template éƒ¨åˆ†ï¼Œåœ¨ç‰ˆæœ¬ä¿¡æ¯åŒºåŸŸæ·»åŠ æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼ˆçº¦ç¬¬ 17-28 è¡Œæ›¿æ¢ï¼‰ï¼š

    ```vue
        <!-- ç‰ˆæœ¬ä¿¡æ¯ -->
        <div class="version-info">
          <div class="version-row">
            <span class="label">å½“å‰ç‰ˆæœ¬:</span>
            <span class="value">{{ version }}</span>
          </div>

          <div v-if="updateInfo" class="version-row">
            <span class="label">æœ€æ–°ç‰ˆæœ¬:</span>
            <span class="value">
              {{ updateInfo.latestVersion }}
              <span v-if="updateInfo.isPrerelease" class="prerelease-badge">
                {{ formatPrereleaseBadge(updateInfo.isPrerelease, updateInfo.latestVersion) }}
              </span>
            </span>
          </div>

          <div v-if="updateInfo" class="version-row">
            <span class="label">æ›´æ–°çŠ¶æ€:</span>
            <span
              :class="['value', 'status-badge', updateInfo.hasUpdate ? 'has-update' : 'latest']"
            >
              {{ updateInfo.hasUpdate ? 'æœ‰æ–°ç‰ˆæœ¬å¯ç”¨' : 'å·²æ˜¯æœ€æ–°ç‰ˆæœ¬' }}
            </span>
          </div>

          <div v-if="updateInfo && updateInfo.publishedAt" class="version-row details">
            <span class="label">å‘å¸ƒæ—¶é—´:</span>
            <span class="value">{{ updateInfo.publishedAt }}</span>
          </div>

          <div v-if="fullVersion !== version" class="version-row details">
            <span class="label">å®Œæ•´ä¿¡æ¯:</span>
            <span class="value monospace">{{ fullVersion }}</span>
          </div>
        </div>
    ```

    ä¿®æ”¹æ£€æŸ¥æ›´æ–°æŒ‰é’®ï¼Œæ·»åŠ åŠ è½½çŠ¶æ€ï¼ˆçº¦ç¬¬ 56-59 è¡Œï¼‰ï¼š

    ```vue
        <button
          @click="checkForUpdates"
          class="btn btn-secondary"
          :disabled="isCheckingUpdate"
        >
          <span class="icon" :class="{ spinning: isCheckingUpdate }">ğŸ”„</span>
          <span>{{ isCheckingUpdate ? 'æ£€æŸ¥ä¸­...' : 'æ£€æŸ¥æ›´æ–°' }}</span>
        </button>
    ```

    æ·»åŠ æ ·å¼ï¼ˆåœ¨ style éƒ¨åˆ†æœ«å°¾æ·»åŠ ï¼‰ï¼š

    ```css
    .prerelease-badge {
      font-size: 11px;
      color: var(--accent-warning);
      font-weight: normal;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-badge.has-update {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.latest {
      background: #d1fae5;
      color: #065f46;
    }

    .icon.spinning {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    ```
  </action>
  <verify>cd frontend && npm run type-check 2>&1 | head -20</verify>
  <done>AboutDialog æ˜¾ç¤ºå®Œæ•´ç‰ˆæœ¬ä¿¡æ¯å¡ç‰‡ï¼ŒåŒ…å«æ›´æ–°çŠ¶æ€å’Œå‘å¸ƒæ—¶é—´</done>
</task>

<task type="checkpoint:human-verify">
  <what-built>
    1. updateStore å¢å¼ºäº†ç”¨æˆ·åé¦ˆï¼ˆtoast æç¤ºå’Œé”™è¯¯å¤„ç†ï¼‰
    2. AboutDialog æ·»åŠ äº†å®Œæ•´çš„ç‰ˆæœ¬ä¿¡æ¯å¡ç‰‡
    3. æ£€æŸ¥æ›´æ–°æŒ‰é’®æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  </what-built>
  <how-to-verify>
    æ‰‹åŠ¨æµ‹è¯•éªŒè¯ï¼š
    1. å¯åŠ¨åº”ç”¨ï¼šwails dev
    2. æ‰“å¼€å…³äºå¯¹è¯æ¡†ï¼ˆç‚¹å‡»å·¥å…·æ çš„"å…³äº"æŒ‰é’®ï¼‰
    3. éªŒè¯ç‰ˆæœ¬ä¿¡æ¯å¡ç‰‡æ˜¾ç¤ºæ­£ç¡®ï¼š
       - å½“å‰ç‰ˆæœ¬å·æ˜¾ç¤º
       - æœ€æ–°ç‰ˆæœ¬å·æ˜¾ç¤º
       - æ›´æ–°çŠ¶æ€å¾½ç« ï¼ˆå·²æ˜¯æœ€æ–°/æœ‰æ–°ç‰ˆæœ¬ï¼‰
       - å‘å¸ƒæ—¶é—´æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
    4. ç‚¹å‡»"æ£€æŸ¥æ›´æ–°"æŒ‰é’®ï¼š
       - æŒ‰é’®æ˜¾ç¤º"æ£€æŸ¥ä¸­..."çŠ¶æ€
       - å›¾æ ‡æ—‹è½¬åŠ¨ç”»
       - å³ä¸‹è§’æ˜¾ç¤º toast æç¤º
    5. æµ‹è¯•ç½‘ç»œé”™è¯¯åœºæ™¯ï¼ˆå¯é€‰ï¼Œæ–­ç½‘åæµ‹è¯•ï¼‰ï¼š
       - æ£€æŸ¥æ›´æ–°åº”æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æ¶ˆæ¯
  </how-to-verify>
  <resume-signal>ç¡®è®¤ç‰ˆæœ¬ä¿¡æ¯æ˜¾ç¤ºæ­£å¸¸ï¼Œæ£€æŸ¥æ›´æ–°æœ‰åé¦ˆï¼Œé”™è¯¯æç¤ºæ¸…æ™°åå›å¤ "approved" æˆ–æè¿°é—®é¢˜</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript ç±»å‹æ£€æŸ¥ï¼šnpm run type-check é€šè¿‡
2. ç¼–è¯‘éªŒè¯ï¼šwails dev å¯åŠ¨æˆåŠŸ
3. åŠŸèƒ½éªŒè¯ï¼š
   - ç‰ˆæœ¬ä¿¡æ¯å¡ç‰‡æ˜¾ç¤ºå®Œæ•´
   - æ£€æŸ¥æ›´æ–°æŒ‰é’®æœ‰åŠ è½½çŠ¶æ€
   - Toast æç¤ºæ­£å¸¸æ˜¾ç¤º
   - é”™è¯¯æ¶ˆæ¯å‹å¥½æ¸…æ™°
</verification>

<success_criteria>
1. ç‰ˆæœ¬ä¿¡æ¯å¡ç‰‡åœ¨å…³äºç•Œé¢æ­£ç¡®æ˜¾ç¤º
2. æ£€æŸ¥æ›´æ–°æŒ‰é’®æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆæ—‹è½¬å›¾æ ‡ + æ–‡å­—å˜åŒ–ï¼‰
3. Toast æç¤ºåœ¨æ£€æŸ¥æ›´æ–°æ—¶æ˜¾ç¤ºï¼ˆæ­£åœ¨æ£€æŸ¥/æ£€æŸ¥å®Œæˆï¼‰
4. é”™è¯¯æ¶ˆæ¯ç”¨æˆ·å‹å¥½ï¼ˆé€Ÿç‡é™åˆ¶/ç½‘ç»œè¶…æ—¶/è¿æ¥å¤±è´¥ï¼‰
5. ä»£ç é€šè¿‡ TypeScript ç±»å‹æ£€æŸ¥
</success_criteria>

<output>
After completion, create `.planning/phases/07-auto-update-detection-fix/07-02-SUMMARY.md`
</output>
