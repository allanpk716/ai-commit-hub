# Phase 2: Single Instance & Window Management - Context

**Gathered:** 2026-02-06
**Status:** Ready for planning

<domain>
## Phase Boundary

实现单实例锁定机制,防止多实例运行,并支持窗口状态持久化。确保同一时间只有一个应用实例运行,窗口位置和大小在重启后能够恢复。

</domain>

<decisions>
## Implementation Decisions

### 多实例检测行为
- **锁定机制**: 使用操作系统级锁(文件锁或互斥量)
- **检测响应**: 静默激活现有窗口,不显示任何通知
- **窗口激活**: 如果窗口最小化,先恢复到正常大小,然后激活到前台
- **激活优先级**: 正常激活到前台(遵守系统规则,不强制覆盖全屏应用)
- **通信超时**: 快速失败策略,立即尝试一次,失败则快速退出
- **崩溃处理**: 依赖操作系统在进程结束时自动释放锁资源
- **日志记录**: 仅记录失败和错误情况,成功时无日志

### 窗口状态持久化
- **保存内容**: 窗口位置(X,Y坐标)、窗口大小(宽高)、最大化状态、显示器编号
- **保存时机**: 窗口关闭时保存最后状态
- **存储位置**: 保存到SQLite数据库的settings表
- **异常处理**: 如果保存的数据损坏或无效(例如位置超出屏幕),使用系统默认值

### 用户反馈机制
- **正常情况**: 静默激活现有窗口,无任何通知或提示
- **激活失败**: 显示错误对话框,包含技术详情(错误信息)
- **日志策略**: 失败时记录详细错误日志到文件

### 启动窗口行为
- **首次启动**: 使用系统默认窗口位置
- **非首次启动**: 在窗口显示前恢复状态(避免闪烁)
- **多显示器处理**: 如果原显示器不存在,使用系统默认位置(不尝试移到主显示器)

### Claude's Discretion
- 锁机制的具体实现细节(文件锁 vs 互斥量)
- 窗口状态验证的具体阈值(例如多少像素算"超出屏幕")
- 错误对话框的具体文案和样式
- 数据库表结构设计(字段命名、数据类型)

</decisions>

<specifics>
## Specific Ideas

- 用户希望体验流畅,检测到多实例时应该"无感知"地激活现有窗口
- 错误处理要透明,失败时显示技术详情便于排查问题
- 窗口状态恢复要平滑,避免视觉闪烁
- 依赖操作系统自动清理锁资源,简化崩溃恢复逻辑

</specifics>

<deferred>
## Deferred Ideas

无 - 讨论保持在阶段范围内

</deferred>

---

*Phase: 02-single-instance-window-management*
*Context gathered: 2026-02-06*
