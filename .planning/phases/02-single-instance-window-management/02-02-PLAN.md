---
phase: 02-single-instance-window-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [pkg/models/window_state.go, pkg/repository/window_state_repository.go, pkg/repository/db.go]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "WindowState 模型定义了窗口状态所需的所有字段"
    - "WindowStateRepository 提供数据访问方法"
    - "数据库迁移包含 WindowState 表"
  artifacts:
    - path: "pkg/models/window_state.go"
      provides: "WindowState 模型"
      min_lines: 20
    - path: "pkg/repository/window_state_repository.go"
      provides: "窗口状态数据访问层"
      min_lines: 30
      exports: ["NewWindowStateRepository", "GetByKey", "Save"]
    - path: "pkg/repository/db.go"
      provides: "数据库迁移入口"
      contains: "WindowState"
  key_links:
    - from: "pkg/repository/db.go"
      to: "pkg/models/window_state.go"
      via: "AutoMigrate"
      pattern: "AutoMigrate.*WindowState"
---

<objective>
创建窗口状态持久化的数据层,包括 WindowState 模型和 Repository,为应用层集成做准备。

Purpose: 建立窗口状态存储的数据基础设施,将数据访问逻辑与业务逻辑分离,遵循项目现有的 Repository 模式。

Output: 完整的数据层实现,包括 GORM 模型、Repository 类和数据库迁移。
</objective>

<execution_context>
@C:\Users\allan716\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\allan716\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-single-instance-window-management/02-CONTEXT.md
@.planning/phases/02-single-instance-window-management/02-RESEARCH.md

@pkg/models/git_project.go
@pkg/repository/db.go
@pkg/repository/git_project_repository.go
</context>

<tasks>

<task type="auto">
  <name>任务 1: 创建 WindowState 模型</name>
  <files>pkg/models/window_state.go</files>
  <action>
    创建新文件 pkg/models/window_state.go,定义 WindowState 结构体:

    ```go
    package models

    import "gorm.io/gorm"

    // WindowState 窗口状态模型
    type WindowState struct {
        gorm.Model
        Key       string `gorm:"uniqueIndex;not null;size:100"` // 配置键(如 "window.main")
        X         int    `gorm:"not null"`                       // 窗口 X 坐标
        Y         int    `gorm:"not null"`                       // 窗口 Y 坐标
        Width     int    `gorm:"not null"`                       // 窗口宽度
        Height    int    `gorm:"not null"`                       // 窗口高度
        Maximized bool   `gorm:"default:false"`                  // 是否最大化
        MonitorID string `gorm:"size:50"`                        // 显示器编号(可选)
    }

    // TableName 指定表名
    func (WindowState) TableName() string {
        return "window_states"
    }
    ```

    注意:
    - 遵循 GORM 命名约定(表名复数形式 window_states)
    - 使用 snake_case 字段名
    - Key 字段添加 uniqueIndex 确保唯一性
    - 参考现有 models 代码风格(git_project.go)
  </action>
  <verify>cat pkg/models/window_state.go | grep -c "WindowState" 返回 > 0</verify>
  <done>pkg/models/window_state.go 文件存在,包含 WindowState 结构体和 TableName 方法</done>
</task>

<task type="auto">
  <name>任务 2: 创建 WindowStateRepository</name>
  <files>pkg/repository/window_state_repository.go</files>
  <action>
    创建新文件 pkg/repository/window_state_repository.go,实现数据访问层:

    ```go
    package repository

    import (
        "github.com/allanpk716/ai-commit-hub/pkg/models"
        "gorm.io/gorm"
    )

    // WindowStateRepository 窗口状态数据访问层
    type WindowStateRepository struct {
        db *gorm.DB
    }

    // NewWindowStateRepository 创建 WindowStateRepository 实例
    func NewWindowStateRepository() *WindowStateRepository {
        return &WindowStateRepository{
            db: GetDB(),
        }
    }

    // GetByKey 根据 key 获取窗口状态
    func (r *WindowStateRepository) GetByKey(key string) (*models.WindowState, error) {
        var state models.WindowState
        err := r.db.Where("key = ?", key).First(&state).Error
        if err != nil {
            return nil, err
        }
        return &state, nil
    }

    // Save 保存或更新窗口状态(Upsert)
    func (r *WindowStateRepository) Save(state *models.WindowState) error {
        return r.db.Save(state).Error
    }

    // DeleteByKey 删除指定 key 的窗口状态
    func (r *WindowStateRepository) DeleteByKey(key string) error {
        return r.db.Where("key = ?", key).Delete(&models.WindowState{}).Error
    }
    ```

    注意:
    - 使用 GetDB() 获取数据库实例(与现有 repository 一致)
    - 使用 GORM 的 Save 方法自动处理 Upsert 逻辑
    - 参考 git_project_repository.go 的代码风格
  </action>
  <verify>cat pkg/repository/window_state_repository.go | grep -c "WindowStateRepository" 返回 > 0</verify>
  <done>pkg/repository/window_state_repository.go 文件存在,包含 GetByKey 和 Save 方法</done>
</task>

<task type="auto">
  <name>任务 3: 更新数据库迁移</name>
  <files>pkg/repository/db.go</files>
  <action>
    修改 pkg/repository/db.go 的 InitializeDatabase 函数:

    1. 在 AutoMigrate 调用中添加 &models.WindowState{}
    2. 修改前: AutoMigrate(&models.GitProject{}, &models.CommitHistory{}, &models.UpdatePreferences{})
    3. 修改后: AutoMigrate(&models.GitProject{}, &models.CommitHistory{}, &models.UpdatePreferences{}, &models.WindowState{})

    注意:
    - 确保添加 models.WindowState 的导入
    - 验证导入部分包含 "github.com/allanpk716/ai-commit-hub/pkg/models"
    - 迁移会在应用启动时自动创建 window_states 表
  </action>
  <verify>grep "WindowState" pkg/repository/db.go | grep AutoMigrate</verify>
  <done>pkg/repository/db.go 的 AutoMigrate 包含 models.WindowState,models 包已导入</done>
</task>

</tasks>

<verification>
1. 编译成功,无错误
2. pkg/models/window_state.go 文件存在并包含 WindowState 模型
3. pkg/repository/window_state_repository.go 文件存在并包含数据访问方法
4. pkg/repository/db.go 的 AutoMigrate 包含 WindowState
5. models 包已在 db.go 中导入
</verification>

<success_criteria>
1. WindowState 模型定义了所有必需字段
2. WindowStateRepository 提供数据访问方法
3. 数据库迁移包含 WindowState 表
</success_criteria>

<output>
After completion, create `.planning/phases/02-single-instance-window-management/02-02-SUMMARY.md`
</output>
