---
phase: 04-auto-update-system
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified: [pkg/update/downloader.go, frontend/src/stores/updateStore.ts, frontend/src/components/UpdateProgressDialog.vue, app.go]
autonomous: false

must_haves:
  truths:
    - "用户点击'立即更新'后开始后台下载"
    - "模态对话框实时显示下载进度（百分比 + 已下载/总大小 + 速度 + 剩余时间）"
    - "下载进度每 100ms 更新一次"
    - "支持断点续传（网络中断后可继续下载）"
    - "下载失败自动重试最多 3 次，每次间隔 5 秒"
    - "提供取消按钮，用户可随时取消下载"
    - "文件完整性双重校验（文件大小 + SHA256/MD5 哈希）"
  artifacts:
    - path: "pkg/update/downloader.go"
      provides: "支持断点续传的下载器"
      exports: ["Download", "Cancel", "SetProgressFunc", "NewResumableDownloader"]
      contains: "Range: bytes=,StatusPartialContent"
    - path: "frontend/src/stores/updateStore.ts"
      provides: "增强的下载状态管理"
      exports: ["downloadUpdate", "cancelDownload", "formatBytes", "calculateETA"]
      contains: "EventsOn.*download-progress"
    - path: "frontend/src/components/UpdateProgressDialog.vue"
      provides: "下载进度对话框组件"
      exports: ["UpdateProgressDialog"]
      min_lines: 150
    - path: "app.go"
      provides: "下载和取消 API"
      exports: ["DownloadUpdate", "CancelDownload"]
  key_links:
    - from: "pkg/update/downloader.go"
      to: "runtime.EventsEmit"
      via: "download-progress event emission"
      pattern: "EventsEmit.*download-progress"
    - from: "frontend/src/stores/updateStore.ts"
      to: "wailsjs/go/main/App"
      via: "DownloadUpdate API call"
      pattern: "DownloadUpdate\\("
    - from: "frontend/src/components/UpdateProgressDialog.vue"
      to: "updateStore"
      via: "useUpdateStore hook"
      pattern: "useUpdateStore\\(\\)"
---

<objective>
实现后台下载和进度显示，支持断点续传

Purpose: 现有下载器功能有限，不支持断点续传、重试和详细进度显示。需要增强下载器功能，实现 HTTP Range 请求支持断点续传，添加自动重试机制，并通过 Wails Events 实时推送进度到前端。前端需要创建下载进度对话框，显示完整的下载信息（百分比、速度、剩余时间等）。

Output: 支持断点续传的下载器，自动重试机制，实时进度推送，详细的下载进度对话框。
</objective>

<execution_context>
@C:\Users\allan716\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\allan716\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-auto-update-system/04-RESEARCH.md
@.planning/phases/04-auto-update-system/04-CONTEXT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@pkg/update/downloader.go
@frontend/src/stores/updateStore.ts
@.planning/phases/04-auto-update-system/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>任务 1: 增强下载器支持断点续传和重试</name>
  <files>pkg/update/downloader.go</files>
  <action>
    增强 `pkg/update/downloader.go`：

    1. 添加新字段支持断点续传和代理：
       ```go
       type Downloader struct {
           client         *http.Client
           downloadDir    string
           onProgress     ProgressFunc
           maxRetries     int           // 最大重试次数（3）
           retryInterval  time.Duration  // 重试间隔（5秒）
           ctx            context.Context
           proxyURL       string        // 代理 URL（新增）
       }
       ```
    2. 修改 `Download()` 方法支持断点续传：
       - 检查 `.tmp` 临时文件是否存在，获取已下载大小
       - 设置 HTTP Range 头：`Range: bytes={offset}-`
       - 处理 206 Partial Content 响应
       - 以追加模式打开文件（O_APPEND）
    3. 添加重试逻辑：
       - 失败时检查是否为可恢复错误
       - 自动重试最多 3 次，每次间隔 5 秒
       - 记录重试日志
    4. 增强 `progressWriter` 进度跟踪：
       - 添加速度计算（bytes per second）
       - 添加剩余时间计算
       - 每 100ms 更新一次进度
    5. 添加文件完整性验证：
       - 下载完成后验证文件大小
       - 计算并验证 SHA256 哈希（如果提供）
    6. **添加代理支持**：
       - 添加 `SetProxy(proxyURL string)` 方法
       - 如果设置了 proxyURL，创建 `http.ProxyURL` 代理
       - 修改 Transport 使用代理
    7. 通过 Wails Events 推送进度：
       - 事件名：`download-progress`
       - 数据：`{percentage, downloaded, total, speed, eta, url}`
       - 使用 `runtime.EventsEmit(d.ctx, ...)`

    **注意**：保持现有的 ProgressFunc 回调兼容性。
  </action>
  <verify>
    ```bash
    cd C:/WorkSpace/Go2Hell/src/github.com/allanpk716/ai-commit-hub
    go test ./pkg/update/ -v -run TestDownloader
    ```
  </verify>
  <done>
    - Download 方法支持断点续传（HTTP Range 请求）
    - 失败时自动重试最多 3 次，间隔 5 秒
    - 进度回调包含速度和剩余时间
    - 文件完整性验证（大小 + 哈希）
    - **支持 HTTP 代理配置**
    - 测试通过
  </done>
</task>

<task type="auto">
  <name>任务 2: 增强 updateStore 下载状态管理</name>
  <files>frontend/src/stores/updateStore.ts</files>
  <action>
    增强 `frontend/src/stores/updateStore.ts`：

    1. 添加新的状态：
       ```typescript
       const downloadedSize = ref(0)
       const totalSize = ref(0)
       const downloadETA = ref('')  // 预计剩余时间
       const canCancel = ref(false)
       ```
    2. 增强 `download-progress` 事件监听：
       - 接收完整数据：`{percentage, downloaded, total, speed, eta, url}`
       - 更新所有相关状态
    3. 添加 `downloadUpdate()` 方法：
       - 调用后端 `DownloadUpdate` API
       - 设置 canCancel 为 true
       - 处理下载完成事件
    4. 添加 `cancelDownload()` 方法：
       - 调用后端 `CancelDownload` API
       - 重置下载状态
    5. 添加工具方法：
       - `formatBytes(bytes)`: 格式化文件大小（KiB/MiB/GiB）
       - `calculateETA(downloaded, total, speed)`: 计算剩余时间
       - `formatSpeed(bytesPerSecond)`: 格式化速度

    **注意**：保持现有方法签名兼容，仅增强功能。
  </action>
  <verify>
    ```bash
    cd C:/WorkSpace/Go2Hell/src/github.com/allanpk716/ai-commit-hub/frontend
    npm run build
    ```
  </verify>
  <done>
    - download-progress 事件处理完整数据
    - downloadUpdate 方法调用后端 API
    - cancelDownload 方法正常工作
    - formatBytes/calculateETA/formatSpeed 工具方法正确
    - 前端构建成功
  </done>
</task>

<task type="auto">
  <name>任务 3: 创建下载进度对话框组件</name>
  <files>frontend/src/components/UpdateProgressDialog.vue</files>
  <action>
    创建 `frontend/src/components/UpdateProgressDialog.vue`：

    1. 组件功能：
       - 模态对话框，阻塞主界面
       - 实时显示下载进度
       - 显示详细信息（百分比、进度条、已下载/总大小、速度、剩余时间）
       - 提供取消按钮

    2. UI 结构：
       ```vue
       <template>
         <div class="modal-overlay">
           <div class="download-dialog">
             <div class="dialog-header">
               <h2>正在下载更新</h2>
             </div>
             <div class="dialog-body">
               <!-- 进度条 -->
               <div class="progress-bar">
                 <div class="progress-fill" :style="{ width: progress + '%' }"></div>
               </div>
               <!-- 百分比 -->
               <div class="progress-text">{{ progress.toFixed(1) }}%</div>
               <!-- 已下载/总大小 -->
               <div class="size-info">{{ formatBytes(downloaded) }} / {{ formatBytes(total) }}</div>
               <!-- 速度 -->
               <div class="speed-info">{{ formatSpeed(speed) }}</div>
               <!-- 剩余时间 -->
               <div class="eta-info">预计剩余: {{ eta }}</div>
             </div>
             <div class="dialog-footer">
               <button @click="cancel" class="btn-cancel">取消</button>
             </div>
           </div>
         </div>
       </template>
       ```

    3. 使用 updateStore 获取状态：
       - progress, downloaded, total, speed, eta
       - cancelDownload 方法

    4. 样式设计：
       - 居中模态对话框
       - 渐变色进度条
       - 清晰的信息层次
       - 取消按钮在底部

    **注意**：样式需与现有 UpdateDialog.vue 保持一致。
  </action>
  <verify>
    ```bash
    cd C:/WorkSpace/Go2Hell/src/github.com/allanpk716/ai-commit-hub/frontend
    npm run build
    ```
  </verify>
  <done>
    - UpdateProgressDialog.vue 组件创建成功
    - 显示完整的下载进度信息
    - 取消按钮正常工作
    - 样式与现有组件一致
    - 前端构建成功
  </done>
</task>

<task type="auto">
  <name>任务 4: 添加 app.go 下载和取消 API</name>
  <files>app.go</files>
  <action>
    在 `app.go` 中添加下载和取消 API：

    1. 添加 `DownloadUpdate(url, filename, proxyURL string) error` 方法：
       ```go
       func (a *App) DownloadUpdate(url, filename, proxyURL string) error {
           if a.initError != nil {
               return fmt.Errorf("app not initialized: %w", a.initError)
           }
           // 创建下载目录
           updatesDir := filepath.Join(getConfigDir(), "updates")
           os.MkdirAll(updatesDir, 0755)

           // 创建下载器
           downloader := update.NewResumableDownloader(updatesDir)
           downloader.SetContext(a.ctx)
           if proxyURL != "" {
               downloader.SetProxy(proxyURL)  // 设置代理
           }
           downloader.SetProgressFunc(func(downloaded, total int64) {
               // 通过 Events 推送进度
           })

           // 开始下载
           _, err := downloader.Download(url, filename)
           return err
       }
       ```

    2. 添加 `CancelDownload(filename string) error` 方法：
       ```go
       func (a *App) CancelDownload(filename string) error {
           updatesDir := filepath.Join(getConfigDir(), "updates")
           downloader := update.NewDownloader(updatesDir)
           return downloader.Cancel(filename)
       }
       ```

    3. 在进度回调中发送事件：
       ```go
       runtime.EventsEmit(a.ctx, "download-progress", map[string]interface{}{
           "percentage": percentage,
           "downloaded": downloaded,
           "total": total,
           "speed": speed,
           "eta": eta,
           "url": url,
       })
       ```

    4. 添加 `getConfigDir()` 辅助函数：
       - Windows: `C:\Users\{username}\.ai-commit-hub`
       - 使用 os.UserHomeDir()

    **注意**：确保检查 initError，保持 API 一致性。
  </action>
  <verify>
    ```bash
    cd C:/WorkSpace/Go2Hell/src/github.com/allanpk716/ai-commit-hub
    go build -o tmp/ai-commit-hub.exe .
    wails generate module
    ```
  </verify>
  <done>
    - DownloadUpdate API 正常工作
    - CancelDownload API 正常工作
    - 进度事件实时推送
    - Wails 绑定生成成功
    - 编译成功
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    完整的后台下载和进度显示系统：
    - pkg/update/downloader.go：支持断点续传和重试
    - frontend/src/stores/updateStore.ts：增强的下载状态管理
    - frontend/src/components/UpdateProgressDialog.vue：下载进度对话框
    - app.go：下载和取消 API
  </what-built>
  <how-to-verify>
    验证步骤：
    1. 启动应用：`wails dev`
    2. 在设置页面或通过托盘菜单触发"检查更新"
    3. 如果有新版本，点击"立即更新"按钮
    4. 观察下载进度对话框：
       - 进度条实时更新
       - 显示百分比、已下载/总大小、速度、剩余时间
       - 信息准确更新（每 100ms）
    5. 测试断点续传：
       - 下载过程中断开网络
       - 恢复网络后自动继续下载
       - 进度从断点继续
    6. 测试取消功能：
       - 点击取消按钮
       - 确认下载停止，临时文件被清理
    7. 测试重试机制：
       - 模拟网络错误
       - 确认自动重试最多 3 次
  </how-to-verify>
  <resume-signal>
    验证通过后输入 "approved"，如有问题请描述具体问题。
  </resume-signal>
</task>

</tasks>

<verification>
整体验证标准：
1. 点击"立即更新"后开始下载
2. 进度对话框显示完整信息（百分比、大小、速度、剩余时间）
3. 断点续传正常工作
4. 下载失败自动重试
5. 取消按钮正常工作
6. 文件完整性验证通过
</verification>

<success_criteria>
- 支持断点续传的下载器
- 自动重试机制（最多 3 次）
- 实时进度推送（每 100ms）
- 详细的下载进度对话框
- 取消下载功能
- 文件完整性验证
</success_criteria>

<output>
完成后创建 `.planning/phases/04-auto-update-system/04-02-SUMMARY.md`
</output>
