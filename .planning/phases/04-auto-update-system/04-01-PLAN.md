---
phase: 04-auto-update-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [pkg/version/version.go, pkg/service/update_service.go, pkg/models/update_info.go, app.go]
autonomous: false

must_haves:
  truths:
    - "应用启动时后台检查 GitHub Releases 最新版本（包括预发布版本）"
    - "设置页面显示当前版本和最新版本信息"
    - "托盘菜单'检查更新'按钮可手动触发检查"
    - "发现新版本后弹出系统托盘通知"
    - "版本比较支持预发布标识符（如 v1.0.0-beta.1 > v1.0.0-alpha.2）"
  artifacts:
    - path: "pkg/version/version.go"
      provides: "语义化版本比较（含预发布版本）"
      exports: ["NormalizeVersion", "SafeCompareVersions", "IsPrerelease"]
      contains: "golang.org/x/mod/semver"
    - path: "pkg/service/update_service.go"
      provides: "版本检测服务（使用 /releases 端点）"
      exports: ["CheckForUpdates", "fetchAllReleases", "findLatestVersion"]
      contains: "api.github.com/repos/.*releases"
    - path: "pkg/models/update_info.go"
      provides: "更新信息模型（增加预发布版本字段）"
      exports: ["UpdateInfo"]
      contains: "IsPrerelease,PrereleaseType"
    - path: "app.go"
      provides: "更新检查入口和事件发射"
      exports: ["CheckForUpdates", "startup"]
  key_links:
    - from: "pkg/service/update_service.go"
      to: "golang.org/x/mod/semver"
      via: "import and use for version comparison"
      pattern: "semver\\.(Compare|IsValid|Prerelease)"
    - from: "app.go:startup"
      to: "updateService.CheckForUpdates"
      via: "goroutine call on startup"
      pattern: "go.*CheckForUpdates\\(\\)"
    - from: "app.go"
      to: "runtime.EventsEmit"
      via: "emit update-available event"
      pattern: "EventsEmit.*update-available"
---

<objective>
实现版本检测和 UI 集成，支持预发布版本

Purpose: 当前版本检测使用 `/releases/latest` 端点，不支持预发布版本。需要改用 `/releases` 端点获取所有 releases，并使用 `golang.org/x/mod/semver` 库进行版本比较。同时完善 UI 集成，在设置页面显示版本信息，在托盘菜单连接"检查更新"按钮。

Output: 支持预发布版本的版本检测服务，完善的版本信息展示，手动检查更新功能。
</objective>

<execution_context>
@C:\Users\allan716\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\allan716\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-auto-update-system/04-RESEARCH.md
@.planning/phases/04-auto-update-system/04-CONTEXT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@pkg/version/version.go
@pkg/service/update_service.go
@app.go
</context>

<tasks>

<task type="auto">
  <name>任务 1: 增强版本比较支持预发布版本</name>
  <files>pkg/version/version.go</files>
  <action>
    修改 `pkg/version/version.go`，使用 `golang.org/x/mod/semver` 库实现版本比较：

    1. 添加 import: `golang.org/x/mod/semver`
    2. 修改正则表达式支持预发布版本：`^v?(\d+)\.(\d+)\.(\d+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?$`
    3. 添加 `NormalizeVersion(version string) string` 函数：
       - 移除空格
       - 确保版本号以 "v" 开头（semver 库要求）
    4. 添加 `SafeCompareVersions(v1, v2 string) int` 函数：
       - 使用 semver.IsValid 验证版本号
       - 使用 semver.Compare 比较版本
       - 无效版本时返回 0
    5. 添加 `IsPrerelease(version string) bool` 函数：
       - 使用 semver.Prerelease 检查是否为预发布版本
    6. 更新 `ParseVersion` 函数支持预发布标识符（返回额外参数 prerelease string）
    7. 更新 `CompareVersions` 使用新的 semver 库实现

    **重要**：保持现有函数签名兼容，仅增强内部实现。
  </action>
  <verify>
    ```bash
    cd C:/WorkSpace/Go2Hell/src/github.com/allanpk716/ai-commit-hub
    go test ./pkg/version/ -v -run TestCompareVersions
    ```
  </verify>
  <done>
    - "golang.org/x/mod/semver" 库已添加到 go.mod
    - NormalizeVersion 函数正确处理 "1.0.0" -> "v1.0.0"
    - SafeCompareVersions 正确比较预发布版本（如 v1.0.0-beta.1 > v1.0.0-alpha.2）
    - IsPrerelease 正确识别预发布版本
    - 现有测试通过
  </done>
</task>

<task type="auto">
  <name>任务 2: 重构 UpdateService 使用 /releases 端点</name>
  <files>pkg/service/update_service.go</files>
  <action>
    重构 `pkg/service/update_service.go`：

    1. 修改 `fetchLatestRelease()` 为 `fetchAllReleases()`：
       - URL 从 `/releases/latest` 改为 `/releases`
       - 返回 []GitHubRelease 而非单个 release
       - 添加过滤逻辑排除 draft releases
    2. 添加 `findLatestVersion(releases []GitHubRelease)` 函数：
       - 使用 semver.Sort 对 releases 排序
       - 返回最新的 release（包括预发布版本）
    3. 修改 `findPlatformAsset()` 精确匹配：
       - 从 `strings.Contains(asset.Name, "windows")` 改为精确匹配 `windows-amd64`
    4. 添加缓存机制：
       - 添加 lastCheck time.Time 字段
       - 添加 cachedResult *models.UpdateInfo 字段
       - 检查间隔 24 小时（使用 time.Since）
       - 速率限制错误时返回缓存
    5. 添加 `isRateLimitError(err error) bool` 函数：
       - 检查 HTTP 403 错误
       - 检查超时错误
    6. 更新 `CheckForUpdates()` 使用新的 fetchAllReleases
    7. **添加后台定时检查**：
       - 添加 `StartBackgroundCheck()` 方法
       - 创建 24 小时定时器：`time.NewTicker(24 * time.Hour)`
       - 在 goroutine 中定期调用 `CheckForUpdates()`
       - 在 app.go 的 `startup()` 中调用此方法启动后台检查

    **注意**：保持 GitHubRelease 和 Asset 结构体不变。
  </action>
  <verify>
    ```bash
    cd C:/WorkSpace/Go2Hell/src/github.com/allanpk716/ai-commit-hub
    go test ./pkg/service/ -v -run TestUpdateService
    ```
  </verify>
  <done>
    - fetchAllReleases 正确调用 /releases 端点
    - findLatestVersion 正确排序并返回最新版本
    - findPlatformAsset 精确匹配 windows-amd64
    - 缓存机制生效（24 小时内重复检查返回缓存）
    - 速率限制错误时返回缓存结果
    - StartBackgroundCheck 方法每 24 小时自动检查更新
  </done>
</task>

<task type="auto">
  <name>任务 3: 增强 UpdateInfo 模型</name>
  <files>pkg/models/update_info.go</files>
  <action>
    增强 `pkg/models/update_info.go` 中的 UpdateInfo 结构体：

    1. 添加预发布版本相关字段：
       ```go
       IsPrerelease   bool   `json:"isPrerelease"`   // 是否为预发布版本
       PrereleaseType string `json:"prereleaseType"` // 预发布类型 (alpha/beta/rc)
       ```
    2. 保持现有字段不变，确保向后兼容

    这些字段将用于前端显示预发布版本标识。
  </action>
  <verify>
    ```bash
    cd C:/WorkSpace/Go2Hell/src/github.com/allanpk716/ai-commit-hub
    go test ./pkg/models/ -v
    go build ./...
    ```
  </verify>
  <done>
    - UpdateInfo 包含 IsPrerelease 和 PrereleaseType 字段
    - 编译成功，无破坏性变更
  </done>
</task>

<task type="auto">
  <name>任务 4: 完善 app.go 更新检查集成</name>
  <files>app.go</files>
  <action>
    完善 `app.go` 中的更新检查功能：

    1. 修改 `startup()` 函数中的异步检查：
       - 保持现有的 goroutine 检查
       - 检查结果通过 `runtime.EventsEmit(ctx, "update-available", info)` 发送
       - 错误时记录日志但不阻塞启动
       - **调用 `a.updateService.StartBackgroundCheck()` 启动定时检查**
    2. 修改 `checkUpdateStub()` 为真实实现：
       - 删除 stub 注释
       - 调用 `a.updateService.CheckForUpdates()`
       - 通过系统托盘通知显示结果（如果有更新）
       - 使用 `runtime.EventsEmit(ctx, "update-available", info)` 发送事件
    3. 确保 `CheckForUpdates()` API 方法正常工作：
       - 检查 initError
       - 返回完整信息

    **注意**：托盘通知使用现有的 `systray.Notify()` 或类似方法。
  </action>
  <verify>
    ```bash
    cd C:/WorkSpace/Go2Hell/src/github.com/allanpk716/ai-commit-hub
    go build -o tmp/ai-commit-hub.exe .
    ```
  </verify>
  <done>
    - 启动时自动后台检查更新（不阻塞）
    - 托盘菜单"检查更新"按钮调用真实 API
    - 发现更新后发送 update-available 事件
    - **每 24 小时后台自动检查更新**
    - 编译成功
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    完整的版本检测和 UI 集成：
    - pkg/version/version.go：支持预发布版本比较
    - pkg/service/update_service.go：使用 /releases 端点获取所有版本
    - pkg/models/update_info.go：增强的更新信息模型
    - app.go：完善的更新检查入口和事件发射
  </what-built>
  <how-to-verify>
    验证步骤：
    1. 启动应用：`wails dev`
    2. 查看日志，确认"检查更新"日志输出
    3. 点击托盘菜单"检查更新"按钮，观察是否正常响应
    4. 检查设置页面是否显示版本信息（当前版本、最新版本）
    5. 如果有新版本，验证是否弹出托盘通知
    6. 测试预发布版本比较：修改当前版本为旧版本，验证是否能检测到预发布版本
    7. **验证 24 小时后台检查：修改 lastCheck 时间为 25 小时前，验证是否自动触发检查**
  </how-to-verify>
  <resume-signal>
    验证通过后输入 "approved"，如有问题请描述具体问题。
  </resume-signal>
</task>

</tasks>

<verification>
整体验证标准：
1. 启动时后台检查更新，日志可见
2. 设置页面显示当前版本和最新版本
3. 托盘菜单"检查更新"按钮正常工作
4. 发现新版本后弹出托盘通知
5. 版本比较支持预发布标识符
6. **每 24 小时后台自动检查更新**
</verification>

<success_criteria>
- 应用启动时自动检查更新
- **每 24 小时后台自动检查更新**
- 版本检测支持预发布版本（alpha/beta/rc）
- 设置页面显示版本信息
- 托盘菜单"检查更新"连接到真实 API
- 更新可用时发送 update-available 事件
</success_criteria>

<output>
完成后创建 `.planning/phases/04-auto-update-system/04-01-SUMMARY.md`
</output>
