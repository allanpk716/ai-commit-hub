# Phase 4: Auto Update System - Context

**Gathered:** 2026-02-07
**Status:** Ready for planning

<domain>
## Phase Boundary

实现完整的自动更新系统，包括版本检测、后台下载、外部更新器程序和自动重启。系统能够从 GitHub Releases 检测新版本（包括预发布版本），流式显示下载进度，使用外部更新器替换应用文件，并在更新完成后自动重启。

</domain>

<decisions>
## Implementation Decisions

### 版本检测行为
- **检测时机**：启动时自动检查 + 每 24 小时后台检查一次
- **更新提示**：发现新版本后静默通知（系统托盘通知）
- **版本比较**：包括预发布版本（alpha、beta、rc 等）
- **API 端点**：使用 `/releases` 端点而非 `/releases/latest`，以支持预发布版本
- **预发布版本支持**：完整支持预发布标识符比较（如 v1.0.0-beta.1 > v1.0.0-alpha.2）
- **检测状态展示**：设置页面 + 主界面横幅都要显示版本信息
- **手动检查入口**：设置页面的"关于"区域提供"检查更新"按钮
- **网络错误处理**：检查失败时弹出 toast 提示，但不阻塞应用使用
- **强制更新**：不支持强制更新，所有更新都是可选的
- **跳过版本**：不支持跳过特定版本

### 下载体验
- **下载触发**：用户点击"立即更新"后立即开始下载
- **进度显示**：模态对话框显示下载进度（阻塞主界面）
- **进度详情**：完整信息（百分比 + 已下载/总大小 + 下载速度 + 预计剩余时间）
- **下载失败处理**：自动重试最多 3 次，每次间隔 5 秒
- **取消下载**：提供"取消"按钮，用户可随时取消
- **文件存储位置**：应用数据目录（`C:\Users\用户\.ai-commit-hub\updates`）
- **文件完整性校验**：双重校验（文件大小 + SHA256 和 MD5 哈希值）
- **断点续传**：支持断点续传（网络中断后可继续下载）
- **并发下载**：单线程下载，不使用多线程
- **下载完成提示**：在模态对话框中显示"下载完成，是否立即安装？"
- **限速控制**：不限制下载速度
- **代理支持**：在设置页面提供代理配置选项，用户手动设置
- **文件保留策略**：安装完成后保留最近 1 次的下载文件
- **磁盘空间检查**：下载前检查磁盘剩余空间
- **下载暂停/恢复**：不支持暂停，仅支持取消
- **版本信息获取**：下载前显示版本号、发布时间、更新内容摘要
- **日志记录**：记录详细日志（时间、版本、速度、结果）到日志文件
- **下载超时**：30 秒连接超时，300 秒总下载超时
- **下载状态持久化**：不保存下载状态，应用关闭后需要重新下载
- **GitHub API 认证**：匿名访问，不使用 Token
- **Release Notes 显示**：在下载对话框中显示前 5 行内容，提供"查看更多"链接
- **进度流式更新**：使用 Wails Events 将下载进度实时推送到前端
- **文件名处理**：保留 GitHub Release 的原始文件名
- **ZIP 文件处理**：保持 ZIP 格式，安装时再解压
- **校验和来源**：从 GitHub Release 页面解析校验和文件
- **下载历史记录**：不记录下载历史
- **下载速度单位**：自动选择单位（KB/s、MB/s、GB/s）
- **下载进度精度**：显示一位小数（如 75.3%）
- **重试间隔**：每次重试间隔 5 秒
- **进度更新频率**：每 100ms 更新一次进度
- **下载任务队列**：仅支持一个下载任务
- **下载配置持久化**：保存代理配置等到数据库或配置文件
- **下载对话框层级**：模态阻塞，下载完成前无法使用应用
- **SSL/TLS 验证**：严格验证证书
- **错误处理**：智能重试（可恢复错误自动重试）
- **文件完整性验证**：双重校验（大小 + 哈希）
- **更新可用性提示**：发现新版本后立即弹出对话框询问是否下载
- **下载预检查**：完整预检查（磁盘空间、网络连接、目录权限等）
- **后台下载**：支持后台下载（用户关闭主界面后继续）
- **文件大小格式化**：使用二进制单位（KiB、MiB、GiB）
- **更新器启动确认**：下载完成后立即提示"安装"或"稍后"

### 更新安装流程
- **安装触发时机**：下载完成后等待用户手动点击"安装"按钮
- **更新器程序**：使用外部更新器程序（updater.exe）
- **安装前确认**：显示确认对话框，提示用户保存工作并关闭应用
- **更新器位置**：内嵌在主程序中，安装时释放到临时目录使用
- **安装进度显示**：更新器显示独立的进度窗口，展示解压、替换等步骤
- **文件替换策略**：先备份旧版本，更新失败时自动回滚
- **备份保留策略**：更新成功后保留最近 1 次的备份
- **安装失败处理**：安装失败时自动恢复备份（回滚到旧版本）
- **更新器权限**：在用户权限下运行，不需要管理员权限
- **安装步骤**：完整流程（解压 ZIP → 停止主应用 → 备份旧版本 → 替换文件 → 清理 → 启动新版本）
- **更新器通信**：通过命令行参数传递信息（安装路径、ZIP 路径等）
- **ZIP 解压位置**：解压到临时目录，验证后再复制到安装目录
- **应用关闭时机**：主应用等待更新器准备就绪后再退出
- **文件锁定处理**：更新器在启动前等待主应用完全退出（最多 30 秒）
- **数据文件处理**：仅替换可执行文件，保留用户数据文件（数据库、配置等）
- **安装超时**：设置 5 分钟超时，超时后回滚
- **安装日志**：更新器记录详细日志到文件
- **安装界面内容**：显示当前步骤（解压、备份、替换等）和整体进度
- **安装验证**：替换完成后验证新版本可执行文件能否正常启动
- **更新器界面语言**：使用中文
- **安装失败通知**：显示错误对话框，提供"查看日志"和"重试"按钮
- **备份目录位置**：备份放在安装目录的 backup 文件夹
- **安装取消支持**：安装开始后无法取消，必须完成
- **ZIP 包内容验证**：解压前验证 ZIP 包结构，确保包含预期的文件
- **清理旧文件**：替换完成后删除旧版本不再需要的文件
- **安装完成提示**：安装完成后更新器显示"更新成功"对话框，3 秒后自动关闭

### 更新后行为
- **自动重启**：更新完成后自动启动新版本应用
- **重启延迟**：显示成功对话框后延迟 2-3 秒再启动
- **首次启动提示**：正常启动，不显示特殊提示

### Claude's Discretion
- 版本比较算法的具体实现细节（semver 库 vs 自定义实现）
- 进度条和动画的具体样式设计
- 更新器窗口的具体 UI 布局
- 日志文件的具体格式和轮转策略
- 错误消息的具体措辞

</decisions>

<specifics>
## Specific Ideas

- **版本查询问题修复**：
  - 当前使用 `/releases/latest` 端点不支持预发布版本
  - 需要改用 `/releases` 端点获取所有 releases
  - `ParseVersion` 函数需要支持预发布标识符（如 `-alpha`、`-beta`、`-rc`）
  - 资源查找逻辑需要精确匹配 `windows-amd64` 而非简单包含 `windows`

- **参考行为**：
  - 类似 VSCode 的更新体验：后台检查 → 通知提示 → 模态下载对话框 → 确认安装 → 自动重启
  - 下载进度类似浏览器下载管理器的详细信息展示

</specifics>

<deferred>
## Deferred Ideas

- 发布管理功能（创建、编辑 GitHub Releases）— 未来可考虑作为独立功能
- 回滚机制（更新失败后手动回滚到指定版本）— 本阶段已实现自动回滚，手动回滚可延后
- 更新源配置（支持从其他源更新而非仅 GitHub Releases）
- 增量更新（仅下载变更的文件）- 复杂度高，当前版本不实现
- 多渠道更新（支持从多个镜像源下载）

</deferred>

---

*Phase: 04-auto-update-system*
*Context gathered: 2026-02-07*
