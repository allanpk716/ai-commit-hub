---
phase: 04-auto-update-system
plan: 04
type: execute
wave: 4
depends_on: [04-02, 04-03]
files_modified: [app.go, frontend/src/stores/updateStore.ts, frontend/src/components/UpdateInstallerDialog.vue, frontend/src/App.vue]
autonomous: false

must_haves:
  truths:
    - "下载完成后提示用户'安装'或'稍后'"
    - "点击'安装'后显示确认对话框，提示用户保存工作"
    - "更新器启动后主程序退出"
    - "更新器显示安装进度（解压、备份、替换、启动）"
    - "更新成功后更新器显示成功对话框，3 秒后自动关闭"
    - "新版本应用在更新完成后自动启动"
    - "更新失败时自动回滚到旧版本"
  artifacts:
    - path: "app.go"
      provides: "完整更新流程入口"
      exports: ["InstallUpdate", "Quit"]
      contains: "installer.Install,Quit"
    - path: "frontend/src/stores/updateStore.ts"
      provides: "更新状态管理"
      exports: ["installUpdate", "isReadyToInstall", "confirmInstall"]
      contains: "InstallUpdate"
    - path: "frontend/src/components/UpdateInstallerDialog.vue"
      provides: "安装确认对话框"
      exports: ["UpdateInstallerDialog"]
      min_lines: 100
    - path: "frontend/src/App.vue"
      provides: "更新对话框集成"
      contains: "UpdateDialog,UpdateProgressDialog,UpdateInstallerDialog"
  key_links:
    - from: "frontend/src/components/UpdateInstallerDialog.vue"
      to: "updateStore.installUpdate"
      via: "用户确认安装后调用"
      pattern: "installUpdate\\(\\)"
    - from: "app.go:InstallUpdate"
      to: "pkg/update/installer.Installer"
      via: "调用 Install 方法启动更新器"
      pattern: "installer\\.Install\\("
    - from: "app.go:InstallUpdate"
      to: "app.Quit"
      via: "更新器启动后退出主程序"
      pattern: "a\\.Quit\\(\\)"
---

<objective>
实现更新替换和自动重启

Purpose: 连接下载和安装流程，实现完整的更新体验。下载完成后提示用户安装，用户确认后启动更新器并退出主程序。更新器完成文件替换后自动启动新版本应用。同时完善前端对话框集成，提供流畅的更新体验。

Output: 完整的更新流程，从下载到安装到重启，用户友好的确认和进度提示。
</objective>

<execution_context>
@C:\Users\allan716\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\allan716\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04-auto-update-system/04-RESEARCH.md
@.planning/phases/04-auto-update-system/04-CONTEXT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@app.go
@frontend/src/stores/updateStore.ts
@frontend/src/components/UpdateDialog.vue
@.planning/phases/04-auto-update-system/04-02-SUMMARY.md
@.planning/phases/04-auto-update-system/04-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>任务 1: 完善 app.go 中的 InstallUpdate 方法</name>
  <files>app.go</files>
  <action>
    完善 `app.go` 中的 `InstallUpdate` 方法：

    1. 找到现有的 InstallUpdate 方法（约在第 857 行）
    2. 修改实现以使用新的 installer：
       ```go
       func (a *App) InstallUpdate(downloadURL, assetName string) error {
           if a.initError != nil {
               return fmt.Errorf("app not initialized: %w", a.initError)
           }

           logger.Info("开始安装更新", "url", downloadURL, "asset", assetName)

           // 构建本地 ZIP 文件路径
           updatesDir := filepath.Join(getConfigDir(), "updates")
           zipPath := filepath.Join(updatesDir, assetName)

           // 验证 ZIP 文件存在
           if _, err := os.Stat(zipPath); os.IsNotExist(err) {
               return fmt.Errorf("更新文件不存在: %s", zipPath)
           }

           // 创建安装器
           installer := update.NewInstaller()

           // 启动更新器（会释放嵌入的更新器并启动）
           if err := installer.Install(zipPath); err != nil {
               return fmt.Errorf("启动更新器失败: %w", err)
           }

           logger.Info("更新器已启动，主程序即将退出")

           // 退出主程序，释放文件锁
           a.Quit()

           return nil
       }
       ```

    3. 确保有 getConfigDir() 辅助函数：
       ```go
       func getConfigDir() string {
           homeDir, _ := os.UserHomeDir()
           return filepath.Join(homeDir, ".ai-commit-hub")
       }
       ```

    4. 确保 Quit() 方法正常工作：
       - 关闭所有窗口
       - 停止所有服务
       - 调用 runtime.Quit

    **注意**：InstallUpdate 是最后调用的方法，之后程序会退出。
  </action>
  <verify>
    ```bash
    cd C:/WorkSpace/Go2Hell/src/github.com/allanpk716/ai-commit-hub
    go build -o tmp/ai-commit-hub.exe .
    ```
  </verify>
  <done>
    - InstallUpdate 方法正确使用 installer.Install()
    - ZIP 文件路径正确构建
    - 更新器启动后调用 Quit()
    - getConfigDir() 返回正确路径
    - 编译成功
  </done>
</task>

<task type="auto">
  <name>任务 2: 增强 updateStore 安装状态管理</name>
  <files>frontend/src/stores/updateStore.ts</files>
  <action>
    增强 `frontend/src/stores/updateStore.ts` 的安装相关功能：

    1. 添加安装相关状态：
       ```typescript
       const isReadyToInstall = ref(false)
       const showInstallConfirm = ref(false)
       const isInstalling = ref(false)
       const installError = ref<string | null>(null)
       ```

    2. 修改 download-complete 事件处理：
       ```typescript
       EventsOn('download-complete', (data: { path: string; size: number }) => {
           isDownloading.value = false
           downloadProgress.value = 100
           isReadyToInstall.value = true
           // 显示安装确认对话框
           showInstallConfirm.value = true
       })
       ```

    3. 添加 installUpdate() 方法：
       ```typescript
       async function installUpdate() {
           if (!updateInfo.value) {
               throw new Error('没有可用的更新信息')
           }

           isInstalling.value = true
           installError.value = null

           try {
               const { InstallUpdate } = await import('../../wailsjs/go/main/App')
               await InstallUpdate(
                   updateInfo.value.downloadURL,
                   updateInfo.value.assetName
               )
               // 注意：成功后程序会退出，不会继续执行
           } catch (error) {
               console.error('安装更新失败:', error)
               installError.value = String(error)
               isInstalling.value = false
               throw error
           }
       }
       ```

    4. 添加 confirmInstall() 方法：
       ```typescript
       async function confirmInstall() {
           showInstallConfirm.value = false
           await installUpdate()
       }
       ```

    5. 添加 cancelInstall() 方法：
       ```typescript
       function cancelInstall() {
           showInstallConfirm.value = false
           isReadyToInstall.value = true  // 保持可安装状态，用户可以稍后安装
       }
       ```

    6. 更新 return 语句导出新状态和方法。

    **注意**：保持现有方法签名兼容。
  </action>
  <verify>
    ```bash
    cd C:/WorkSpace/Go2Hell/src/github.com/allanpk716/ai-commit-hub/frontend
    npm run build
    ```
  </verify>
  <done>
    - download-complete 事件触发安装确认
    - installUpdate 调用后端 InstallUpdate API
    - confirmInstall 和 cancelInstall 方法正常工作
    - 安装错误正确处理
    - 前端构建成功
  </done>
</task>

<task type="auto">
  <name>任务 3: 创建安装确认对话框组件</name>
  <files>frontend/src/components/UpdateInstallerDialog.vue</files>
  <action>
    创建 `frontend/src/components/UpdateInstallerDialog.vue`：

    1. 组件功能：
       - 安装确认对话框
       - 显示更新信息（版本号、文件大小）
       - 警告用户保存工作
       - 提供"立即安装"和"稍后"按钮

    2. UI 结构：
       ```vue
       <template>
         <div v-if="visible" class="modal-overlay" @click.self="close">
           <div class="install-dialog">
             <div class="dialog-header">
               <h2>准备安装更新</h2>
             </div>
             <div class="dialog-body">
               <div class="warning-box">
                 <div class="warning-icon">!</div>
                 <div class="warning-text">
                   <p>安装更新时，应用将关闭并重新启动。</p>
                   <p>请确保已保存当前的工作。</p>
                 </div>
               </div>
               <div class="update-info">
                 <div class="info-row">
                   <span class="label">版本:</span>
                   <span class="value">{{ updateInfo?.latestVersion }}</span>
                 </div>
                 <div class="info-row">
                   <span class="label">文件大小:</span>
                   <span class="value">{{ formattedSize }}</span>
                 </div>
               </div>
             </div>
             <div class="dialog-footer">
               <button @click="confirm" class="btn-confirm" :disabled="isInstalling">
                 {{ isInstalling ? '正在启动...' : '立即安装' }}
               </button>
               <button @click="close" class="btn-later" :disabled="isInstalling">
                 稍后
               </button>
             </div>
           </div>
         </div>
       </template>
       ```

    3. 脚本部分：
       ```typescript
       import { computed } from 'vue'
       import { useUpdateStore } from '../stores/updateStore'

       const props = defineProps<{
         visible: boolean
       }>()

       const emit = defineEmits(['close'])

       const updateStore = useUpdateStore()
       const updateInfo = computed(() => updateStore.updateInfo)
       const isInstalling = computed(() => updateStore.isInstalling)
       const formattedSize = computed(() => updateStore.formattedSize)

       function close() {
         emit('close')
       }

       async function confirm() {
         try {
           await updateStore.confirmInstall()
         } catch (error) {
           // 错误已在 store 中处理
         }
       }
       ```

    4. 样式设计：
       - 警告框使用黄色/橙色背景
       - "立即安装"按钮使用渐变色
       - 与现有对话框风格一致

    **注意**：样式需与 UpdateDialog.vue 保持一致。
  </action>
  <verify>
    ```bash
    cd C:/WorkSpace/Go2Hell/src/github.com/allanpk716/ai-commit-hub/frontend
    npm run build
    ```
  </verify>
  <done>
    - UpdateInstallerDialog.vue 组件创建成功
    - 显示更新信息和警告
    - "立即安装"和"稍后"按钮正常工作
    - 样式与现有组件一致
    - 前端构建成功
  </done>
</task>

<task type="auto">
  <name>任务 4: 集成所有更新对话框到 App.vue</name>
  <files>frontend/src/App.vue</files>
  <action>
    在 `frontend/src/App.vue` 中集成所有更新对话框：

    1. 导入对话框组件：
       ```vue
       <script setup lang="ts">
       import UpdateDialog from './components/UpdateDialog.vue'
       import UpdateProgressDialog from './components/UpdateProgressDialog.vue'
       import UpdateInstallerDialog from './components/UpdateInstallerDialog.vue'
       import { useUpdateStore } from './stores/updateStore'

       const updateStore = useUpdateStore()
       </script>
       ```

    2. 添加对话框到模板：
       ```vue
       <template>
         <!-- 其他内容 -->
         <UpdateDialog
           :visible="updateStore.hasUpdate && !updateStore.isDownloading"
           @close="updateStore.resetUpdateState"
         />
         <UpdateProgressDialog
           :visible="updateStore.isDownloading"
         />
         <UpdateInstallerDialog
           :visible="updateStore.showInstallConfirm"
           @close="updateStore.cancelInstall"
         />
       </template>
       ```

    3. 确保对话框显示逻辑正确：
       - UpdateDialog：发现更新时显示
       - UpdateProgressDialog：下载中显示
       - UpdateInstallerDialog：下载完成等待安装确认时显示

    **注意**：确保对话框不会同时显示多个（使用互斥条件）。
  </action>
  <verify>
    ```bash
    cd C:/WorkSpace/Go2Hell/src/github.com/allanpk716/ai-commit-hub/frontend
    npm run build
    ```
  </verify>
  <done>
    - 所有更新对话框导入并添加到模板
    - 对话框显示逻辑正确（互斥）
    - 事件处理正确（close、cancelInstall）
    - 前端构建成功
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    完整的更新替换和自动重启流程：
    - app.go：InstallUpdate 方法完善
    - frontend/src/stores/updateStore.ts：安装状态管理
    - frontend/src/components/UpdateInstallerDialog.vue：安装确认对话框
    - frontend/src/App.vue：所有对话框集成
  </what-built>
  <how-to-verify>
    完整更新流程验证：
    1. 启动应用：`wails dev`
    2. 模拟有新版本可用（修改版本检测或使用真实更新）
    3. 点击"立即更新"开始下载
    4. 观察下载进度对话框：
       - 进度条实时更新
       - 显示速度和剩余时间
    5. 下载完成后自动弹出安装确认对话框：
       - 显示版本号和文件大小
       - 显示警告信息
    6. 点击"立即安装"：
       - 主程序退出
       - 更新器启动并显示进度
       - 文件被替换
       - 新版本自动启动
    7. 验证新版本正常运行
    8. 测试"稍后"按钮：
       - 点击后对话框关闭
       - 可以稍后再次触发安装

    回滚测试：
    1. 模拟更新失败（修改 ZIP 文件）
    2. 观察是否自动回滚到旧版本
    3. 验证应用仍可正常启动
  </how-to-verify>
  <resume-signal>
    验证通过后输入 "approved"，如有问题请描述具体问题。
  </resume-signal>
</task>

</tasks>

<verification>
整体验证标准：
1. 下载完成后提示安装
2. 安装确认对话框显示正确信息
3. 点击安装后更新器启动
4. 主程序正确退出
5. 更新器完成文件替换
6. 新版本自动启动
7. 更新失败时自动回滚
8. 所有对话框显示逻辑正确
</verification>

<success_criteria>
- 完整的更新流程（下载 -> 确认 -> 安装 -> 重启）
- 用户友好的确认和进度提示
- 更新失败自动回滚
- 更新成功后自动启动新版本
- 所有对话框正确集成
</success_criteria>

<output>
完成后创建 `.planning/phases/04-auto-update-system/04-04-SUMMARY.md`
</output>
