---
phase: 06-日志系统修复
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - main.go
  - app.go
  - pkg/service/update_service.go
  - pkg/update/downloader.go
  - pkg/update/installer.go
  - pkg/service/startup_service.go
  - pkg/service/error_service.go
  - pkg/service/project_config_service.go
  - pkg/service/commit_service.go
  - pkg/git/filecontent.go
  - pkg/repository/migration.go
  - pkg/pushover/installer.go
  - pkg/pushover/status.go
autonomous: true

must_haves:
  truths:
    - "所有 logger.Info/Error/Warn/Debug 调用使用正确的方法签名"
    - "带格式化参数的调用使用 Infof/Errorf/Warnf/Debugf"
    - "带结构化字段的调用使用 WithField/WithFields 链式调用"
    - "简单消息使用普通方法（单参数）"
  artifacts:
    - path: "main.go"
      provides: "日志方法签名修复"
    - path: "app.go"
      provides: "日志方法签名修复"
  key_links:
    - from: "所有 Go 文件"
      to: "logger 方法调用"
      via: "方法签名修复"
      pattern: "logger\\.(Info|Error|Warn|Debug)f\\("
---

<objective>
修复所有 logger 调用方法签名错误，确保日志调用符合 logrus/WQGroup logger 的 API 规范。

目的：修复错误的多参数日志调用，避免日志输出格式混乱和潜在的编译错误。
输出：所有 logger 调用使用正确的方法签名
</objective>

<execution_context>
@C:\Users\allan716\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\allan716\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-日志系统修复/06-日志系统修复-RESEARCH.md

# Prior decisions affecting this plan
- logger 调用方法签名规范：区分普通方法和格式化方法
- 不带格式化参数使用 logger.Error(msg)
- 带格式化参数使用 logger.Errorf(fmt, args...)
- 带结构化字段使用 WithField/WithFields 链式调用

# Current issues identified
根据 RESEARCH.md 的分析，代码中存在约 30+ 处错误的 logger 调用，例如：
- `logger.Info("发现新版本", "version", updateInfo.LatestVersion)`
- `logger.Info("托盘图标双击,显示窗口")`
- `logger.Debug("窗口已可见,跳过显示")`
</context>

<tasks>

<task type="auto">
  <name>修复 main.go 中的 logger 方法签名错误</name>
  <files>main.go</files>
  <action>
    修复 main.go 中所有错误的 logger 调用。

    问题调用（第53, 78-79, 107-110, 118行）：
    ```go
    // 第53行
    logger.Info("Logger initialized, log directory:", logDir)
    // 修复为：
    logger.Infof("Logger initialized, log directory: %s", logDir)

    // 第78-79行
    logger.Info("AI Commit Hub starting up...", "version", version.GetVersion())
    logger.Debug("Full version info", "info", version.GetFullVersion())
    // 修复为：
    logger.WithField("version", version.GetVersion()).Info("AI Commit Hub starting up...")
    logger.WithField("info", version.GetFullVersion()).Debug("Full version info")

    // 第107-110行
    logger.Info("从数据库恢复窗口状态",
        "position", fmt.Sprintf("(%d,%d)", state.X, state.Y),
        "size", fmt.Sprintf("%dx%d", state.Width, state.Height),
        "maximized", state.Maximized)
    // 修复为：
    logger.WithFields(map[string]interface{}{
        "position":  fmt.Sprintf("(%d,%d)", state.X, state.Y),
        "size":      fmt.Sprintf("%dx%d", state.Width, state.Height),
        "maximized": state.Maximized,
    }).Info("从数据库恢复窗口状态")

    // 第118行
    logger.Info("未找到保存的窗口状态，使用默认值")
    // 修复为：
    logger.Info("未找到保存的窗口状态，使用默认值") // 无需修复，单参数正确
    ```

    检查 main.go 中所有类似的调用并修复。
  </action>
  <verify>
    grep -n 'logger\.\(Info\|Error\|Warn\|Debug\)([^,)]*,[^)]*)' main.go 确认无错误调用
  </verify>
  <done>
    main.go 中所有 logger 调用使用正确的方法签名
  </done>
</task>

<task type="auto">
  <name>修复 app.go 中的 logger 方法签名错误</name>
  <files>app.go</files>
  <action>
    修复 app.go 中所有错误的 logger 调用。

    问题调用（约25处）：
    ```go
    // 第252行
    logger.Info("发现新版本", "version", updateInfo.LatestVersion)
    // 修复为：
    logger.WithField("version", updateInfo.LatestVersion).Info("发现新版本")

    // 第306行
    logger.Info("使用 Wails 生成的托盘图标 ICO", "sizes", sizes, "bytes", len(appIconICO))
    // 修复为：
    logger.WithFields(map[string]interface{}{
        "sizes": sizes,
        "bytes": len(appIconICO),
    }).Info("使用 Wails 生成的托盘图标 ICO")

    // 第364行
    logger.Info("托盘图标 ICO 自检通过", "sizes", sizes, "bytes", len(iconBytes))
    // 修复为：
    logger.WithFields(map[string]interface{}{
        "sizes": sizes,
        "bytes": len(iconBytes),
    }).Info("托盘图标 ICO 自检通过")

    // 第367, 371行（类似模式）
    logger.Warn("托盘图标格式未知", "bytes", len(iconBytes))
    logger.Warn("非 Windows 平台检测到 ICO 图标资源", "bytes", len(iconBytes))
    // 修复为：
    logger.WithField("bytes", len(iconBytes)).Warn("托盘图标格式未知")
    logger.WithField("bytes", len(iconBytes)).Warn("非 Windows 平台检测到 ICO 图标资源")

    // 第383行
    logger.Info("托盘图标双击,显示窗口")
    // 修复为：
    logger.WithField("module", "systray").Info("托盘图标双击，显示窗口")

    // 第443, 479行
    logger.Debug("窗口已可见,跳过显示")
    logger.Debug("窗口已隐藏,跳过隐藏")
    // 修复为：
    logger.Debug("窗口已可见，跳过显示")
    logger.Debug("窗口已隐藏，跳过隐藏")

    // 第459, 503, 608, 625, 628, 662, 666行（类似模式）
    // 根据上下文选择 WithField 或直接使用 *f 方法

    // 第883, 894, 925, 960, 970, 982行（更新相关）
    logger.Info("开始安装更新", "url", downloadURL, "asset", assetName)
    // 修复为：
    logger.WithFields(map[string]interface{}{
        "url":   downloadURL,
        "asset": assetName,
    }).Info("开始安装更新")
    ```

    检查 app.go 中所有类似的调用并修复。
  </action>
  <verify>
    grep -n 'logger\.\(Info\|Error\|Warn\|Debug\)([^,)]*,[^)]*)' app.go 确认无错误调用
  </verify>
  <done>
    app.go 中所有 logger 调用使用正确的方法签名
  </done>
</task>

<task type="auto">
  <name>修复 pkg/service 中的 logger 方法签名错误</name>
  <files>
    pkg/service/update_service.go
    pkg/service/startup_service.go
    pkg/service/error_service.go
    pkg/service/project_config_service.go
    pkg/service/commit_service.go
  </files>
  <action>
    修复 pkg/service 目录下所有 Go 文件中的 logger 方法签名错误。

    检查文件：
    1. pkg/service/update_service.go
       - 第70行：logger.Info("检查更新", "repo", s.repo)
       - 第107行：logger.Info("版本信息", "current", currentVersion, "latest", latestVersion)

    2. 其他 service 文件中的类似问题

    修复模式：
    - 多参数键值对 -> WithField 或 WithFields
    - 单参数简单消息 -> 保持不变
    - 需要格式化 -> *f 方法
  </action>
  <verify>
    grep -rn 'logger\.\(Info\|Error\|Warn\|Debug\)([^,)]*,[^)]*)' pkg/service/ 确认无错误调用
  </verify>
  <done>
    pkg/service 目录下所有 logger 调用使用正确的方法签名
  </done>
</task>

<task type="auto">
  <name>修复 pkg/update 中的 logger 方法签名错误</name>
  <files>
    pkg/update/downloader.go
    pkg/update/installer.go
  </files>
  <action>
    修复 pkg/update 目录下所有 Go 文件中的 logger 方法签名错误。

    检查文件：
    1. pkg/update/installer.go
       - 第47行：logger.Info("开始安装更新...", "zip", updateZipPath)

    2. 其他 update 文件中的类似问题
  </action>
  <verify>
    grep -rn 'logger\.\(Info\|Error\|Warn\|Debug\)([^,)]*,[^)]*)' pkg/update/ 确认无错误调用
  </verify>
  <done>
    pkg/update 目录下所有 logger 调用使用正确的方法签名
  </done>
</task>

<task type="auto">
  <name>修复 pkg/git 和 pkg/repository 中的 logger 方法签名错误</name>
  <files>
    pkg/git/filecontent.go
    pkg/repository/migration.go
  </files>
  <action>
    修复 pkg/git 和 pkg/repository 目录下所有 Go 文件中的 logger 方法签名错误。

    检查并修复所有类似的错误调用模式。
  </action>
  <verify>
    grep -rn 'logger\.\(Info\|Error\|Warn\|Debug\)([^,)]*,[^)]*)' pkg/git/ pkg/repository/ 确认无错误调用
  </verify>
  <done>
    pkg/git 和 pkg/repository 目录下所有 logger 调用使用正确的方法签名
  </done>
</task>

<task type="auto">
  <name>修复 pkg/pushover 中的 logger 方法签名错误</name>
  <files>
    pkg/pushover/installer.go
    pkg/pushover/status.go
  </files>
  <action>
    修复 pkg/pushover 目录下所有 Go 文件中的 logger 方法签名错误。

    检查并修复所有类似的错误调用模式。
  </action>
  <verify>
    grep -rn 'logger\.\(Info\|Error\|Warn\|Debug\)([^,)]*,[^)]*)' pkg/pushover/ 确认无错误调用
  </verify>
  <done>
    pkg/pushover 目录下所有 logger 调用使用正确的方法签名
  </done>
</task>

</tasks>

<verification>
1. 全量搜索确认无遗漏的错误调用：
   `grep -rn 'logger\.\(Info\|Error\|Warn\|Debug\)([^,)]*,[^)]*)' . --include="*.go" --exclude-dir=".planning"`

2. 编译测试：
   `go build -o build/bin/ai-commit-hub.exe .`

3. 运行应用程序，观察日志输出格式是否正常
</verification>

<success_criteria>
- [ ] grep 搜索无结果（无错误的 logger 调用）
- [ ] 代码编译通过
- [ ] 日志输出格式符合标准
- [ ] 无编译错误或警告
</success_criteria>

<output>
完成后创建 `.planning/phases/06-日志系统修复/06-03-SUMMARY.md`
</output>
