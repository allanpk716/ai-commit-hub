---
phase: 06-日志系统修复
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - main.go
  - pkg/repository/db.go
autonomous: true

must_haves:
  truths:
    - "日志格式使用 withField 格式器"
    - "时间戳格式为 2006-01-02 15:04:05.000（毫秒级）"
    - "日志级别显示为 [INFO], [ERROR] 等格式"
    - "禁用调用者信息（DisableCaller=true）"
  artifacts:
    - path: "main.go"
      provides: "日志初始化配置"
      min_lines: 30
      contains: "FormatterType"
    - path: "pkg/repository/db.go"
      provides: "数据库日志配置"
      contains: "logger.SetLoggerSettings"
  key_links:
    - from: "main.go"
      to: "github.com/WQGroup/logger"
      via: "logger.SetLoggerSettings"
      pattern: "logger.SetLoggerSettings"
---

<objective>
修复日志格式为标准 withField 格式器，确保所有日志输出符合统一的格式标准。

目的：统一日志格式，提高日志可读性和可解析性。
输出：配置好的日志系统，输出格式为 `2025-12-18 18:32:07.379 - [INFO]: 消息内容`
</objective>

<execution_context>
@C:\Users\allan716\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\allan716\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-日志系统修复/06-日志系统修复-RESEARCH.md

# Prior decisions affecting this plan
- 日志库选择：使用 `github.com/WQGroup/logger`
- 日志格式标准：使用 withField 格式器
- 时间戳精度：毫秒级（YYYY-MM-DD HH:MM:SS.mmm）
</context>

<tasks>

<task type="auto">
  <name>修改 main.go 中的日志格式配置</name>
  <files>main.go</files>
  <action>
    在 initLogger() 函数中修改 Settings 配置：

    1. 修改 FormatterType 为 "withField"（当前是 "text"）
    2. 添加 TimestampFormat: "2006-01-02 15:04:05.000"（毫秒级时间戳）
    3. 添加 DisableCaller: true（禁用调用者信息）
    4. 确保 DisableTimestamp: false
    5. 确保 DisableLevel: false

    当前配置（第43-50行）：
    ```go
    logger.SetLoggerSettings(
        &logger.Settings{
            LogRootFPath:  logDir,
            LogNameBase:   "app.log",
            MaxSizeMB:     100,
            MaxAgeDays:    30,
            FormatterType: "text",
        },
    )
    ```

    修改为：
    ```go
    logger.SetLoggerSettings(
        &logger.Settings{
            LogRootFPath:     logDir,
            LogNameBase:      "app.log",
            MaxSizeMB:        100,
            MaxAgeDays:       30,
            FormatterType:    "withField",
            TimestampFormat:  "2006-01-02 15:04:05.000",
            DisableTimestamp: false,
            DisableLevel:     false,
            DisableCaller:    true,
        },
    )
    ```
  </action>
  <verify>
    运行 `go build -o build/bin/ai-commit-hub.exe .` 确保编译通过
  </verify>
  <done>
    main.go 中的日志配置使用 withField 格式器，时间戳精确到毫秒
  </done>
</task>

<task type="auto">
  <name>修改 pkg/repository/db.go 中的日志配置</name>
  <files>pkg/repository/db.go</files>
  <action>
    检查 pkg/repository/db.go 文件，确保数据库初始化时的日志配置与 main.go 一致。

    如果文件中存在独立的日志配置：
    1. 确保使用相同的 withField 格式器
    2. 确保时间戳格式一致
    3. 移除重复的配置，依赖 main.go 中的全局配置

    如果没有独立配置，此任务只需验证文件不覆盖全局日志设置。
  </action>
  <verify>
    1. grep -n "logger.SetLoggerSettings" pkg/repository/db.go 确认配置状态
    2. 确保编译通过
  </verify>
  <done>
    数据库模块使用统一的 withField 日志格式配置
  </done>
</task>

</tasks>

<verification>
执行 `wails build` 或 `go build` 确保编译通过。如果条件允许，运行应用程序并检查日志文件输出格式是否符合标准：
- 时间戳格式：2025-12-18 18:32:07.379
- 日志级别：[INFO], [ERROR] 等
- 无调用者信息（文件名:行号）
</verification>

<success_criteria>
- [ ] main.go 中 FormatterType 设置为 "withField"
- [ ] 时间戳格式设置为 "2006-01-02 15:04:05.000"
- [ ] DisableCaller 设置为 true
- [ ] 代码编译通过
- [ ] 日志输出格式符合标准
</success_criteria>

<output>
完成后创建 `.planning/phases/06-日志系统修复/06-01-SUMMARY.md`
</output>
