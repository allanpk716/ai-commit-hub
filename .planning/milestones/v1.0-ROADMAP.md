# Milestone v1.0: Foundation & Infrastructure

**Status:** ✅ SHIPPED 2026-02-07
**Phases:** 1-5
**Total Plans:** 14

## Overview

AI Commit Hub 的 v1.0 里程碑聚焦于构建稳定可靠的应用基础设施。从 CI/CD 流水线开始，建立自动化发布能力；然后实现单实例锁定和窗口管理，奠定应用基础；接着修复系统托盘交互，确保用户体验；最后实现自动更新系统，让用户能够无缝获取最新版本。整个旅程从构建基础设施开始，以交付完整的桌面应用体验结束。

## Phases

### Phase 1: CI/CD Pipeline

**Goal**: 建立自动化构建和发布流程，确保代码能够自动编译、测试并发布到 GitHub Releases

**Completed**: 2026-02-06

**Depends on**: Nothing

**Requirements**: CI-01, CI-02, CI-03, CI-04, CI-05

**Success Criteria** (what must be TRUE):
1. ✓ Push tag to GitHub 时自动触发构建流程
2. ✓ 构建流程生成 Windows 平台可执行文件
3. ✓ 构建产物自动上传到 GitHub Releases
4. ✓ 资源文件命名遵循平台检测规范（ai-commit-hub-windows-amd64-v{version}.zip）

**Plans**: 3 plans complete

Plans:
- [x] 01-01-PLAN.md — 创建 GitHub Actions 基础工作流，配置 Wails 构建和版本注入 ✅
- [x] 01-02-PLAN.md — 实现产物打包（exe + 文档）和校验和生成 ✅
- [x] 01-03-PLAN.md — 配置自动发布到 GitHub Releases，支持预发布版本检测 ✅

**Details**:
- 使用 goreleaser-action 优化构建流程
- 自动生成 SHA256 校验和
- 构建缓存加速（15秒 → 10秒）
- 支持 pre-release 检测（alpha/beta/rc）

---

### Phase 2: Single Instance & Window Management

**Goal**: 实现单实例锁定机制，防止多实例运行，并支持窗口状态持久化

**Completed**: 2026-02-06

**Depends on**: Nothing

**Requirements**: SI-01, SI-02, SI-03, SI-04

**Success Criteria** (what must be TRUE):
1. ✓ 应用启动时自动检测是否已有实例运行
2. ✓ 检测到多实例时，自动激活现有窗口到前台
3. ✓ 窗口位置和大小在下次启动时自动恢复
4. ✓ 使用 Wails 内置 SingleInstanceLock 机制

**Plans**: 3 plans complete

Plans:
- [x] 02-01-PLAN.md — 实现单实例锁定和窗口激活 ✅
- [x] 02-02-PLAN.md — 创建窗口状态数据层(模型、Repository、迁移) ✅
- [x] 02-03-PLAN.md — 实现窗口状态保存和恢复逻辑 ✅

**Details**:
- SingleInstanceLock UUID: 'e3984e08-28dc-4e3d-b70a-45e961589cdc'
- 窗口激活策略：静默激活（恢复最小化 + 显示到前台，无通知）
- 窗口状态保存：使用 SQLite + GORM
- 边界验证：minWidth 400, minHeight 300, maxCoord 10000
- 启动时序优化：main.go 预读取数据库设置窗口大小

---

### Phase 3: System Tray Fixes

**Goal**: 修复系统托盘双击功能，升级依赖库，优化托盘交互体验

**Completed**: 2026-02-06

**Depends on**: Phase 2

**Requirements**: TRAY-01, TRAY-02, TRAY-03, TRAY-04, TRAY-05

**Success Criteria** (what must be TRUE):
1. ✓ 双击托盘图标能够恢复并激活主界面到前台
2. ✓ 右键菜单显示"显示/隐藏"、"检查更新"、"退出"选项
3. ✓ 使用 sync.Once 和 atomic.Bool 防止托盘竞态条件
4. ✓ 区分"最小化到托盘"和"退出应用"行为

**Plans**: 2 plans complete

Plans:
- [x] 03-01-PLAN.md — 升级 systray 库到 lutischan-ferenc/systray v1.3.0 并实现双击支持 ✅
- [x] 03-02-PLAN.md — 修复托盘竞态条件和优化退出行为 ✅

**Details**:
- 升级 systray 库：getlantern/systray v1.2.2 → lutischan-ferenc/systray v1.3.0
- API 迁移：从 Channel API 迁移到 Callback API
- 双击实现：使用 SetOnDClick() 实现托盘图标双击恢复窗口
- 竞态条件防护：使用 sync.Once 和 atomic.Bool
- 退出/最小化分离：通过 quitting atomic.Bool 区分两种行为

---

### Phase 4: Auto Update System

**Goal**: 实现完整的自动更新系统，包括版本检测、下载和替换更新

**Completed**: 2026-02-07

**Depends on**: Phase 1, Phase 3

**Requirements**: UPD-01, UPD-02, UPD-03, UPD-04, UPD-05, UPD-06, UPD-07, UPD-08

**Success Criteria** (what must be TRUE):
1. ✓ 应用启动时后台检查 GitHub Releases 最新版本
2. ✓ 主界面提供"检查更新"按钮，设置页面显示版本信息
3. ✓ 后台下载更新文件并通过 Wails Events 流式显示进度
4. ✓ 使用外部更新器程序替换主应用，避免文件锁定
5. ✓ 更新完成后自动重启应用

**Plans**: 4 plans complete

Plans:
- [x] 04-01-PLAN.md — 实现版本检测和 UI 集成（支持预发布版本）✅
- [x] 04-02-PLAN.md — 实现后台下载和进度显示（支持断点续传）✅
- [x] 04-03-PLAN.md — 实现外部更新器程序（嵌入主程序）✅
- [x] 04-04-PLAN.md — 实现更新替换和自动重启 ✅

**Details**:
- 版本比较：使用 golang.org/x/mod/semver 实现标准语义化版本比较
- 版本检测：使用 /releases 而非 /releases/latest 支持预发布版本
- 缓存机制：24 小时 TTL + 速率限制时返回缓存
- 断点续传：使用 HTTP Range 请求实现
- 外部更新器：独立 main 包，使用 embed.FS 嵌入
- 更新器大小：3.2MB
- 文件回滚：更新失败时自动回滚到备份版本
- UI 组件：UpdateDialog, UpdateProgressDialog, UpdateInstallerDialog, AboutDialog

---

### Phase 5: Code Quality & Polish

**Goal**: 修复编译错误和测试失败，确保代码质量和可维护性

**Completed**: 2026-02-07

**Depends on**: Phase 4

**Requirements**: Q-01, Q-02, Q-03, Q-04, Q-05

**Success Criteria** (what must be TRUE):
1. ✓ 项目能够成功编译，无编译错误
2. ✓ 所有测试通过，无重复函数和类型错误
3. ✓ app.go:969 logger.Errorf 使用正确的格式字符串
4. ✓ error_service_test.go 无重复函数声明

**Plans**: 2 plans complete

Plans:
- [x] 05-01: 修复编译错误 ✅
- [x] 05-02: 修复测试错误 ✅

**Details**:
- 修复 logger.Errorf 格式字符串错误：10 处（app.go 2处，commit_service.go 8处）
- 删除重复函数：TestFrontendError_JSON
- 删除未使用导入：logger in error_service_test.go
- 修复测试数据：update_service_test.go 平台名称格式（windows → windows-amd64）
- 修复测试路径：pushover_update_test.go 文件路径错误（删除 .claude/ 前缀）
- 最终结果：0 编译错误，0 测试失败

---

## Milestone Summary

**Decimal Phases:**
None

**Key Decisions:**
- SingleInstanceLock 策略：使用固定 UUID 'e3984e08-28dc-4e3d-b70a-45e961589cdc'
- 窗口激活策略：静默激活（恢复最小化 + 显示到前台，无通知）
- 外部更新器模式：独立进程等待主程序退出后替换文件（Windows 文件锁定解决方案）
- 版本比较库：使用 golang.org/x/mod/semver 实现标准语义化版本比较
- systray 库升级：使用 lutischan-ferenc/systray v1.3.0 替代 getlantern/systray
- 更新器嵌入策略：使用 //go:embed 将 updater.exe 嵌入主程序
- 文件回滚机制：更新失败时自动回滚到备份版本

**Issues Resolved:**
- Windows 控制台窗口闪烁问题：使用 CREATE_NO_WINDOW 标志
- 窗口启动时序问题（闪烁）：通过 main.go 预读取解决
- UNIQUE constraint 错误：通过 Upsert 策略解决
- 最大化状态恢复问题：通过延迟 100ms 解决
- 系统托盘双击失效：升级 systray 库并使用 Callback API
- 托盘竞态条件：使用 sync.Once 和 atomic.Bool 防护
- Windows 文件锁定：使用外部更新器程序突破限制
- 编译错误：修复 10 处 logger 调用格式字符串问题
- 测试失败：修复 2 个测试的数据和路径错误

**Issues Deferred:**
None

**Technical Debt Incurred:**
- 无重大技术债务
- 代码质量高（0 编译错误，0 测试失败）

---

**Milestone Stats:**
- Files: 38 files created/modified
- LOC: 7,115 lines (Go + Vue + TypeScript)
- Phases: 5 phases, 14 plans, ~60 tasks
- Timeline: ~5 hours active development (2026-02-07)
- Git range: v0.2.0-beta.1 → v1.0.0

---

_For current project status, see .planning/ROADMAP.md_

---
*Archived: 2026-02-07 as part of v1.0 milestone completion*
