name: Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 30

    outputs:
      VERSION: ${{ steps.meta.outputs.VERSION }}
      PRERELEASE: ${{ steps.meta.outputs.PRERELEASE }}

    env:
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version metadata
        id: meta
        shell: bash
        run: |
          # Extract version from tag (remove 'v' prefix)
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

          # Get short commit SHA
          SHA=$(git rev-parse --short HEAD)
          echo "SHA=${SHA}" >> $GITHUB_OUTPUT

          # Get build date in ISO 8601 format
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "DATE=${DATE}" >> $GITHUB_OUTPUT

          # Detect prerelease (alpha, beta, rc, pre)
          if [[ "${VERSION}" =~ -(alpha|beta|rc|pre) ]]; then
            echo "PRERELEASE=true" >> $GITHUB_OUTPUT
          else
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
          fi

          echo "Version: ${VERSION}"
          echo "Commit SHA: ${SHA}"
          echo "Build Time: ${DATE}"
          echo "Prerelease: $([[ "${VERSION}" =~ -(alpha|beta|rc|pre) ]] && echo 'yes' || echo 'no')"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Install Wails CLI
        shell: bash
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Node.js dependencies
        shell: bash
        run: |
          cd frontend
          npm install

      - name: Build Wails application (prepare)
        shell: bash
        run: wails build -clean

      - name: Inject version info and rebuild
        shell: bash
        env:
          CGO_ENABLED: '1'
        run: |
          wails build -clean -ldflags "
            -X 'github.com/allanpk716/ai-commit-hub/pkg/version.Version=${{ steps.meta.outputs.VERSION }}'
            -X 'github.com/allanpk716/ai-commit-hub/pkg/version.CommitSHA=${{ steps.meta.outputs.SHA }}'
            -X 'github.com/allanpk716/ai-commit-hub/pkg/version.BuildTime=${{ steps.meta.outputs.DATE }}'
            -s -w"

      - name: Verify version injection
        shell: bash
        run: |
          ./build/bin/ai-commit-hub.exe --version
          if [ $? -eq 0 ]; then
            echo "Version verification successful"
          else
            echo "Version verification failed"
            exit 1
          fi

      - name: Create release package
        shell: bash
        run: |
          cd build/bin
          cp "${GITHUB_WORKSPACE}/README.md" .
          cp "${GITHUB_WORKSPACE}/docs/config-examples/config.yaml" ./config.yaml
          7z a "../ai-commit-hub-windows-amd64-v${{ steps.meta.outputs.VERSION }}.zip" \
            ai-commit-hub.exe README.md config.yaml
          echo "Package created: ai-commit-hub-windows-amd64-v${{ steps.meta.outputs.VERSION }}.zip"

      - name: Generate checksums
        shell: bash
        run: |
          cd build
          for file in *.zip; do
            sha256sum "$file" > "${file}.sha256"
            md5sum "$file" > "${file}.md5"
          done

          # Display checksums
          echo "::notice::SHA256 Checksums:"
          cat *.sha256
          echo "::notice::MD5 Checksums:"
          cat *.md5

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-commit-hub-windows-amd64-v${{ steps.meta.outputs.VERSION }}
          path: |
            build/*.zip
            build/*.sha256
            build/*.md5
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.zip
            artifacts/**/*.sha256
            artifacts/**/*.md5
          name: v${{ needs.build.outputs.VERSION }}
          generate_release_notes: true
          draft: false
          prerelease: ${{ needs.build.outputs.PRERELEASE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
