# 定位与解决 Windows 托盘图标空白问题

## 1. 调试与证据收集
你反馈修改两次依然有问题，且 `wails dev` 下图标空白。为了彻底定位，我们需要看到“实际发生了什么”。
- **动作**：修改代码，将 `getTrayIcon()` 最终决定使用的图标数据写入到项目根目录的 `debug_tray_icon.ico` 文件中。
- **目的**：
  - 如果生成的文件是好的（用图片浏览器能打开，包含多尺寸），说明问题出在 `systray` 库与 Windows API 的交互，或者 Wails 干扰。
  - 如果生成的文件是坏的，说明我们的 `pngToICO` 转换逻辑有误，或者源 PNG 有问题。

## 2. 强制备用方案（Red Box）
为了排除一切“资源解析”问题，我们将内置一个“绝对能用”的硬编码图标。
- **动作**：在 `tray_icon.go` 中添加一个生成纯红 16x16 像素 ICO 的函数。如果自检失败，使用这个纯色图标作为最后的兜底。
- **目的**：如果连这个红色方块都显示不出来，那问题就在系统环境或库本身，与图片资源无关。

## 3. Wails 隔离测试
`wails dev` 环境比较复杂。
- **建议**：请在应用补丁后，尝试运行 `go build -v` 生成 exe 直接运行。
- **动作**：在 `main.go` 中，尝试将 `app.runSystray()` 移到 `wails.Run` 之前更早的位置（虽然现在已经在前了），或者尝试完全独立于 Wails 的生命周期启动它（仅用于测试）。目前维持现状，先通过日志和 Dump 文件分析。

## 4. 依赖库的最终确认
我们之前查到 `lutischan-ferenc/systray` 在 `go.mod` 里。这个库是 `systray` 的一个 fork。
- **风险**：Fork 版本可能落后主线修复，或者引入了新 Bug。
- **动作**：如果上述 Dump 文件正常但依然不显示，我们将把 `go.mod` 里的 `systray` 替换回 `getlantern/systray`（原版）或 `energye/systray`（Wails 社区常用版）。但这是下一步，先看 Dump 结果。

## 执行计划
1.  修改 `app.go`：在 `SetIcon` 前写入 `debug_tray_icon.ico`。
2.  修改 `tray_icon.go`：优化 `pngToICO`，确保生成的 ICO 格式绝对标准（目前的实现是用 PNG 封装在 ICO 容器里，Windows Vista+ 支持，但为了兼容性，我们可以尝试生成 BMP 格式的 ICO，或者确认 PNG 格式没问题）。目前的实现逻辑看起来是正确的（PNG inside ICO）。
3.  编译验证。

## 待确认事项
请在补丁应用后，运行程序，然后检查项目根目录下的 `debug_tray_icon.ico`。这将是破案的关键。