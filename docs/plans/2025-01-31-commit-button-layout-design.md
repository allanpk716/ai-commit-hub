# Commit æŒ‰é’®å¸ƒå±€ä¸åˆ†æ”¯çŠ¶æ€æ˜¾ç¤ºè®¾è®¡

**æ—¥æœŸ:** 2025-01-31
**çŠ¶æ€:** è®¾è®¡å®Œæˆ

## æ¦‚è¿°

å°†"æäº¤åˆ°æœ¬åœ°"å’Œ"æ¨é€"æŒ‰é’®ç§»è‡³æ ‡é¢˜æ ä¸"ç”Ÿæˆæ¶ˆæ¯"æŒ‰é’®åŒè¡Œæ˜¾ç¤ºï¼Œå¹¶åœ¨é¡¹ç›®çŠ¶æ€å¤´éƒ¨æ˜¾ç¤ºæœ¬åœ°åˆ†æ”¯ä¸è¿œç¨‹åˆ†æ”¯çš„åŒæ­¥çŠ¶æ€ï¼ˆé¢†å…ˆ/è½åæ•°é‡ï¼‰ã€‚

## è®¾è®¡ç›®æ ‡

1. æå‡æ“ä½œæ•ˆç‡ï¼šä¸»è¦æ“ä½œæŒ‰é’®é›†ä¸­åœ¨æ ‡é¢˜æ ï¼Œæ— éœ€æ»šåŠ¨
2. çŠ¶æ€å¯è§†åŒ–ï¼šæ¸…æ™°æ˜¾ç¤ºåˆ†æ”¯åŒæ­¥çŠ¶æ€ï¼Œè¾…åŠ©ç”¨æˆ·å†³ç­–
3. å¸ƒå±€æ•´æ´ï¼šæ‰€æœ‰æŒ‰é’®åœ¨ä¸€è¡Œå†…ï¼Œä¿æŒç•Œé¢ç®€æ´

## å¸ƒå±€è®¾è®¡

### æ ‡é¢˜æ å¸ƒå±€

æ ‡é¢˜æ åˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸï¼Œä»å·¦åˆ°å³ä¾æ¬¡æ’åˆ—ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ ä¸»è¦æ“ä½œ â”‚ â”‚   AI é…ç½®        â”‚ â”‚      å·¥å…·æŒ‰é’®            â”‚    â”‚
â”‚ â”‚ âœ¨ç”Ÿæˆ   â”‚ â”‚ ğŸŒProvider ğŸŒè¯­è¨€ â”‚ â”‚ è‡ªå®šä¹‰ æ¸…é™¤Ã—            â”‚    â”‚
â”‚ â”‚ âœ“æäº¤    â”‚ â”‚                  â”‚ â”‚                          â”‚    â”‚
â”‚ â”‚ â†‘æ¨é€    â”‚ â”‚                  â”‚ â”‚                          â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å·¦ä¾§ - ä¸»è¦æ“ä½œæŒ‰é’®ç»„ï¼š**
- `âœ¨ ç”Ÿæˆæ¶ˆæ¯` - å§‹ç»ˆæ˜¾ç¤º
- `âœ“ æäº¤åˆ°æœ¬åœ°` - ä»…åœ¨ç”Ÿæˆæ¶ˆæ¯åæ˜¾ç¤º
- `â†‘ æ¨é€` - ä»…åœ¨ç”Ÿæˆæ¶ˆæ¯åæ˜¾ç¤º

**ä¸­é—´ - AI é…ç½®æ§ä»¶ï¼š**
- ğŸŒ Provider é€‰æ‹©å™¨
- ğŸŒ è¯­è¨€é€‰æ‹©å™¨

**å³ä¾§ - å·¥å…·æŒ‰é’®ï¼š**
- è‡ªå®šä¹‰é…ç½®æ ‡è®°ï¼ˆå¦‚é€‚ç”¨ï¼‰
- æ¸…é™¤æŒ‰é’®ï¼ˆæœ‰æ¶ˆæ¯æ—¶ï¼‰

### åˆ†æ”¯çŠ¶æ€æ˜¾ç¤º

åœ¨é¡¹ç›®çŠ¶æ€å¤´éƒ¨ï¼ˆ`ProjectStatusHeader` ç»„ä»¶ï¼‰çš„åˆ†æ”¯å¾½ç« æ—è¾¹æ˜¾ç¤ºåŒæ­¥çŠ¶æ€ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ai-commit-hub  [â‘‚ main â†‘3 â†“2]  [ğŸ“] [âŒ˜] [â†»]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€å¾½ç« æ ·å¼ï¼š**
- `â†‘3` - ç»¿è‰²ï¼Œæœ¬åœ°é¢†å…ˆ 3 ä¸ªæäº¤ï¼ˆå¯æ¨é€ï¼‰
- `â†“2` - æ©™è‰²ï¼Œæœ¬åœ°è½å 2 ä¸ªæäº¤ï¼ˆéœ€è¦æ‹‰å–ï¼‰
- `â†‘3 â†“2` - çº¢è‰²ï¼Œåˆ†æ”¯åˆ†å‰ï¼ˆé¢†å…ˆ 3 ä¸ªï¼Œè½å 2 ä¸ªï¼‰
- æ— å¾½ç«  - å·²åŒæ­¥ï¼ˆahead=0, behind=0ï¼‰

## æ•°æ®ç»“æ„æ‰©å±•

### PushStatus æ‰©å±•

**Go åç«¯ (`pkg/git/git.go`)ï¼š**
```go
type PushStatus struct {
    CanPush       bool   `json:"canPush"`
    AheadCount    int    `json:"ahead_count"`
    BehindCount   int    `json:"behind_count"`   // æ–°å¢
    RemoteBranch  string `json:"remote_branch"`
    Error         string `json:"error,omitempty"`
}
```

**TypeScript å‰ç«¯ (`frontend/src/types/status.ts`)ï¼š**
```typescript
export interface PushStatus {
    canPush: boolean
    aheadCount: number
    behindCount: number   // æ–°å¢
    remoteBranch: string
    error?: string
}
```

## å®ç°ç»†èŠ‚

### åç«¯å®ç°

**`pkg/git/git.go` - `GetPushStatus` å‡½æ•°æ›´æ–°ï¼š**

1. æ£€æµ‹è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ï¼ˆç°æœ‰é€»è¾‘ï¼‰
2. ç»Ÿè®¡é¢†å…ˆæ•°é‡ï¼ˆç°æœ‰é€»è¾‘ï¼‰
3. **æ–°å¢ï¼š** ç»Ÿè®¡è½åæ•°é‡

```go
// Count remote commits ahead of local
cmd3 := Command("git", "rev-list", "--count", "HEAD..@{u}")
cmd3.Dir = projectPath
var behindCount bytes.Buffer
cmd3.Stdout = &behindCount
if err := cmd3.Run(); err != nil {
    behindCount.WriteString("0")  // å¤±è´¥æ—¶é»˜è®¤ä¸º 0
}

behind := strings.TrimSpace(behindCount.String())
behindCountInt := 0
if behind != "" {
    behindCountInt, _ = strconv.Atoi(behind)
}

return &PushStatus{
    CanPush:      count > 0,
    AheadCount:   count,
    BehindCount:  behindCountInt,  // æ–°å¢
    RemoteBranch: remoteBranchName,
}, nil
```

### å‰ç«¯å®ç°

**1. CommitPanel.vue - æ ‡é¢˜æ é‡æ„**

ç§»é™¤åŸæœ‰çš„ `.action-buttons` åŒºåŸŸï¼Œå°†æäº¤/æ¨é€æŒ‰é’®ç§»å…¥æ ‡é¢˜æ ï¼š

```vue
<div class="result-header">
  <div class="header-left">
    <button class="btn-generate-main" @click="handleGenerate">
      <span class="btn-icon">âœ¨</span>
      <span class="btn-text">ç”Ÿæˆæ¶ˆæ¯</span>
    </button>

    <template v-if="commitStore.streamingMessage || commitStore.generatedMessage">
      <button @click="handleCommit" class="btn-action-inline btn-primary-inline">
        <span class="icon">âœ“</span>
        æäº¤
      </button>
      <button @click="handlePush" class="btn-action-inline btn-push-inline">
        <span class="icon">â†‘</span>
        æ¨é€
      </button>
    </template>
  </div>

  <div class="header-center"><!-- é…ç½®æ§ä»¶ --></div>
  <div class="header-right"><!-- å·¥å…·æŒ‰é’® --></div>
</div>
```

ä¿ç•™è¾…åŠ©æ“ä½œæŒ‰é’®ï¼ˆå¤åˆ¶ã€é‡æ–°ç”Ÿæˆï¼‰åœ¨æ¶ˆæ¯åŒºåŸŸä¸‹æ–¹ï¼Œä½¿ç”¨æ›´ç´§å‡‘çš„æ ·å¼ã€‚

**2. ProjectStatusHeader.vue - åˆ†æ”¯çŠ¶æ€å¾½ç« **

```vue
<template>
  <div class="branch-badge-wrapper">
    <span class="branch-badge">
      <span class="icon">â‘‚</span>
      {{ branch }}
    </span>

    <span v-if="syncStatus" class="sync-status-badge" :class="syncStatusClass">
      {{ syncStatusText }}
    </span>
  </div>
</template>

<script setup lang="ts">
const syncStatus = computed(() => {
  const pushStatus = statusCache.getPushStatus(props.projectPath)
  if (!pushStatus) return null

  const ahead = pushStatus.aheadCount || 0
  const behind = pushStatus.behindCount || 0

  if (ahead === 0 && behind === 0) return null

  return { ahead, behind }
})

const syncStatusText = computed(() => {
  if (!syncStatus.value) return ''
  const { ahead, behind } = syncStatus.value
  let text = ''
  if (ahead > 0) text += `â†‘${ahead}`
  if (behind > 0) text += (text ? ' ' : '') + `â†“${behind}`
  return text
})

const syncStatusClass = computed(() => {
  if (!syncStatus.value) return ''
  const { ahead, behind } = syncStatus.value
  if (ahead > 0 && behind === 0) return 'status-ahead'
  if (behind > 0 && ahead === 0) return 'status-behind'
  return 'status-diverged'
})
</script>
```

**æ ·å¼å®šä¹‰ï¼š**
```css
.sync-status-badge.status-ahead {
  background: rgba(16, 185, 129, 0.2);
  color: var(--accent-success);
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.sync-status-badge.status-behind {
  background: rgba(245, 158, 11, 0.2);
  color: var(--accent-warning);
  border: 1px solid rgba(245, 158, 11, 0.3);
}

.sync-status-badge.status-diverged {
  background: rgba(239, 68, 68, 0.2);
  color: var(--accent-error);
  border: 1px solid rgba(239, 68, 68, 0.3);
}
```

**3. statusCache.ts - ç¡®ä¿å­—æ®µæ­£ç¡®ä¼ é€’**

æ— éœ€ä¿®æ”¹ï¼Œ`refresh` æ–¹æ³•ä¸­çš„ `Promise.all` ä¼šè‡ªåŠ¨è·å–æ–°å¢çš„ `behindCount` å­—æ®µã€‚

## çŠ¶æ€æ›´æ–°æµç¨‹

### æœ¬åœ°æäº¤å
1. è°ƒç”¨ `CommitLocally` æˆåŠŸ
2. è°ƒç”¨ `statusCache.refresh(path, { force: true })`
3. `aheadCount` è‡ªåŠ¨ +1
4. UI è‡ªåŠ¨æ›´æ–°

### æ¨é€å
1. è°ƒç”¨ `PushToRemote` æˆåŠŸ
2. è°ƒç”¨ `statusCache.refresh(path, { force: true })`
3. `aheadCount` å½’é›¶
4. UI è‡ªåŠ¨æ›´æ–°ï¼Œæ¨é€æŒ‰é’®ç¦ç”¨

## è¾¹ç¼˜æƒ…å†µå¤„ç†

| åœºæ™¯ | è¡Œä¸º |
|------|------|
| æ— è¿œç¨‹ä»“åº“ | æ˜¾ç¤º "æœªé…ç½®è¿œç¨‹ä»“åº“"ï¼Œä¸æ˜¾ç¤ºåŒæ­¥å¾½ç«  |
| åˆ†æ”¯åˆ†å‰ | æ˜¾ç¤º `â†‘3 â†“2` çº¢è‰²å¾½ç«  |
| å·²åŒæ­¥ | ä¸æ˜¾ç¤ºåŒæ­¥å¾½ç«  |
| æ¨é€ä¸­ | æŒ‰é’®æ˜¾ç¤º "æ¨é€ä¸­..." å¹¶ç¦ç”¨ï¼Œå›¾æ ‡æ—‹è½¬ |
| è·å–å¤±è´¥ | ä½¿ç”¨ç¼“å­˜æ—§çŠ¶æ€å¹¶æ ‡è®° `stale` |

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

1. `pkg/git/git.go` - æ‰©å±• `PushStatus` å’Œ `GetPushStatus`
2. `frontend/src/types/status.ts` - æ‰©å±• `PushStatus` æ¥å£
3. `frontend/src/components/CommitPanel.vue` - é‡æ„æ ‡é¢˜æ å¸ƒå±€
4. `frontend/src/components/ProjectStatusHeader.vue` - æ·»åŠ åŒæ­¥çŠ¶æ€å¾½ç« 
5. `frontend/src/stores/statusCache.ts` - æ— éœ€ä¿®æ”¹ï¼ˆè‡ªåŠ¨å…¼å®¹ï¼‰
