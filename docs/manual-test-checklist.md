# StatusCache 缓存一致性修复 - 手动测试清单

## 测试目标

验证"未暂存文件添加到暂存区后偶发显示未跟踪"的 bug 是否已修复。

## 测试前准备

1. 启动应用：`wails dev`
2. 确保有测试项目，且有未暂存和未跟踪文件

## 测试清单

### ✅ 单个文件暂存测试

**步骤：**
1. 选择一个有未暂存文件的项目
2. 暂存单个未暂存文件
3. 观察项目列表中的"未跟踪"数量指示器

**预期结果：**
- 如果暂存的是未跟踪文件，未跟踪数量应正确减少
- 如果暂存的是未暂存文件，未跟踪数量应保持不变
- 数量不应出现偶发性错误

---

### ✅ 批量暂存测试

**步骤：**
1. 选择一个有多个未暂存文件的项目
2. 使用"全部暂存"或批量选择多个文件暂存
3. 观察项目列表中的"未跟踪"数量指示器

**预期结果：**
- 未跟踪数量应正确反映暂存后的状态
- 不会出现暂存后仍显示未跟踪的情况

---

### ✅ 快速连续暂存测试（重点）

**步骤：**
1. 选择一个有多个文件的项目
2. 快速连续地点击暂存多个文件（间隔 < 1 秒）
3. 观察项目列表中的状态变化

**预期结果：**
- 每次点击后状态应立即正确更新
- 不会出现状态混乱或数量错误
- 最终状态与实际 Git 状态一致

---

### ✅ 暂存后取消测试

**步骤：**
1. 暂存一个文件
2. 立即取消暂存该文件
3. 观察未跟踪数量是否正确恢复

**预期结果：**
- 取消暂存后，未跟踪数量应正确恢复
- 不会出现数量不匹配的情况

---

### ✅ 项目切换测试

**步骤：**
1. 在项目 A 中暂存文件
2. 切换到项目 B
3. 切换回项目 A
4. 观察项目 A 的状态

**预期结果：**
- 项目 A 的状态应保持一致
- 未跟踪数量显示正确

---

### ✅ 页面刷新测试

**步骤：**
1. 暂存一些文件，观察状态
2. 刷新页面（F5）
3. 观察预加载后的状态

**预期结果：**
- 页面加载后状态与刷新前一致
- 未跟踪数量正确

---

## 开发者调试

### 检查缓存健康状态

在浏览器控制台执行：

```javascript
// 获取 StatusCache 实例
const { useStatusCache } = window.pinia.state.value._p?.s?.get('statusCache')?.()
const statusCache = useStatusCache()

// 查看健康状态
console.log(statusCache.getHealthStatus())

// 手动修复所有缓存
statusCache.validateAndFixAll()
```

### 预期输出

```javascript
{
  total: 2,           // 缓存的项目总数
  consistent: 2,      // 一致的项目数
  inconsistent: []    // 不一致的项目路径列表（应为空）
}
```

---

## Bug 修复验证

### 原始 Bug 现象

- 未暂存的文件添加到暂存区后，偶发显示为未跟踪状态
- 快速连续操作时更容易触发

### 修复后预期

- 所有操作后状态始终正确
- 快速连续操作不会导致状态混乱
- `untrackedCount` 与 `stagingStatus.untracked.length` 始终一致

---

## 测试完成标准

- [ ] 所有测试项目通过
- [ ] `getHealthStatus()` 显示所有缓存一致
- [ ] 原始 bug 不再复现
- [ ] 快速连续操作不会导致状态错误
